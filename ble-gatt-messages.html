<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 BLE GATT Messages | Big Data Case Studies</title>
  <meta name="description" content="Chapter 6 BLE GATT Messages | Big Data Case Studies" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 BLE GATT Messages | Big Data Case Studies" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Chapter 6 BLE GATT Messages | Big Data Case Studies" />
  <meta name="github-repo" content="bchwtz/bchwtz-bdcs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 BLE GATT Messages | Big Data Case Studies" />
  
  <meta name="twitter:description" content="Chapter 6 BLE GATT Messages | Big Data Case Studies" />
  

<meta name="author" content="Benjamin Buchwitz" />


<meta name="date" content="2021-03-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="backend.html"/>
<link rel="next" href="sensor-1.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><b>Big Data Case Studies</b></a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>2</b> Getting Started</a><ul>
<li class="chapter" data-level="2.1" data-path="getting-started.html"><a href="getting-started.html#sensor-dev-env"><i class="fa fa-check"></i><b>2.1</b> Sensor Dev Env</a></li>
<li class="chapter" data-level="2.2" data-path="getting-started.html"><a href="getting-started.html#gateway-dev-env"><i class="fa fa-check"></i><b>2.2</b> Gateway Dev Env</a></li>
</ul></li>
<li class="part"><span><b>Documentation</b></span></li>
<li class="chapter" data-level="3" data-path="sensor.html"><a href="sensor.html"><i class="fa fa-check"></i><b>3</b> Sensor</a><ul>
<li class="chapter" data-level="3.1" data-path="sensor.html"><a href="sensor.html#initializing-acceleration-logging"><i class="fa fa-check"></i><b>3.1</b> Initializing acceleration logging</a></li>
<li class="chapter" data-level="3.2" data-path="sensor.html"><a href="sensor.html#retrieving-data-from-fifo"><i class="fa fa-check"></i><b>3.2</b> Retrieving data from FIFO</a></li>
<li class="chapter" data-level="3.3" data-path="sensor.html"><a href="sensor.html#using-the-data-by-hearbeat"><i class="fa fa-check"></i><b>3.3</b> Using the data by hearbeat</a></li>
<li class="chapter" data-level="3.4" data-path="sensor.html"><a href="sensor.html#initialization-during-boot"><i class="fa fa-check"></i><b>3.4</b> Initialization during boot</a></li>
<li class="chapter" data-level="3.5" data-path="sensor.html"><a href="sensor.html#implementation"><i class="fa fa-check"></i><b>3.5</b> Implementation</a><ul>
<li class="chapter" data-level="3.5.1" data-path="sensor.html"><a href="sensor.html#app_accelerometer_logging.c"><i class="fa fa-check"></i><b>3.5.1</b> app_accelerometer_logging.c</a></li>
<li class="chapter" data-level="3.5.2" data-path="sensor.html"><a href="sensor.html#app_comms.c"><i class="fa fa-check"></i><b>3.5.2</b> app_comms.c</a></li>
<li class="chapter" data-level="3.5.3" data-path="sensor.html"><a href="sensor.html#app_config.h"><i class="fa fa-check"></i><b>3.5.3</b> app_config.h</a></li>
<li class="chapter" data-level="3.5.4" data-path="sensor.html"><a href="sensor.html#app_heartbeat.c"><i class="fa fa-check"></i><b>3.5.4</b> app_heartbeat.c</a></li>
<li class="chapter" data-level="3.5.5" data-path="sensor.html"><a href="sensor.html#app_sensor.c"><i class="fa fa-check"></i><b>3.5.5</b> app_sensor.c</a></li>
<li class="chapter" data-level="3.5.6" data-path="sensor.html"><a href="sensor.html#main.c"><i class="fa fa-check"></i><b>3.5.6</b> main.c</a></li>
<li class="chapter" data-level="3.5.7" data-path="sensor.html"><a href="sensor.html#ruuvi_interface_lis2dh12.c"><i class="fa fa-check"></i><b>3.5.7</b> ruuvi_interface_lis2dh12.c</a></li>
<li class="chapter" data-level="3.5.8" data-path="sensor.html"><a href="sensor.html#ruuvi_nrf5_sdk_rtc_mcu.c"><i class="fa fa-check"></i><b>3.5.8</b> ruuvi_nrf5_sdk_rtc_mcu.c</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="sensor.html"><a href="sensor.html#ringbuffer-module"><i class="fa fa-check"></i><b>3.6</b> Ringbuffer module</a><ul>
<li class="chapter" data-level="3.6.1" data-path="sensor.html"><a href="sensor.html#general-functionality"><i class="fa fa-check"></i><b>3.6.1</b> General functionality</a></li>
<li class="chapter" data-level="3.6.2" data-path="sensor.html"><a href="sensor.html#project-related-use-case"><i class="fa fa-check"></i><b>3.6.2</b> Project-related use case</a></li>
<li class="chapter" data-level="3.6.3" data-path="sensor.html"><a href="sensor.html#implemented-functions"><i class="fa fa-check"></i><b>3.6.3</b> Implemented functions</a></li>
<li class="chapter" data-level="3.6.4" data-path="sensor.html"><a href="sensor.html#exemplary-use"><i class="fa fa-check"></i><b>3.6.4</b> Exemplary use</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gateway.html"><a href="gateway.html"><i class="fa fa-check"></i><b>4</b> Gateway</a></li>
<li class="chapter" data-level="5" data-path="backend.html"><a href="backend.html"><i class="fa fa-check"></i><b>5</b> Backend</a></li>
<li class="chapter" data-level="6" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html"><i class="fa fa-check"></i><b>6</b> BLE GATT Messages</a><ul>
<li class="chapter" data-level="6.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#control-messages"><i class="fa fa-check"></i><b>6.1</b> Control messages</a><ul>
<li class="chapter" data-level="6.1.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#start-transmitting-last-sample-0x03"><i class="fa fa-check"></i><b>6.1.1</b> Start transmitting last sample (<code>0x03</code>)</a></li>
<li class="chapter" data-level="6.1.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#start-transmitting-logged-data-0x05"><i class="fa fa-check"></i><b>6.1.2</b> Start transmitting logged data (<code>0x05</code>)</a></li>
<li class="chapter" data-level="6.1.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#set-configuration-of-acceleration-sensor-0x06"><i class="fa fa-check"></i><b>6.1.3</b> Set configuration of acceleration sensor (<code>0x06</code>)</a></li>
<li class="chapter" data-level="6.1.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#read-configuration-of-acceleration-sensor-0x07"><i class="fa fa-check"></i><b>6.1.4</b> Read configuration of acceleration sensor (<code>0x07</code>)</a></li>
<li class="chapter" data-level="6.1.5" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#set-system-time-0x08"><i class="fa fa-check"></i><b>6.1.5</b> Set system time (<code>0x08</code>)</a></li>
<li class="chapter" data-level="6.1.6" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#read-system-time-0x09"><i class="fa fa-check"></i><b>6.1.6</b> Read system time (<code>0x09</code>)</a></li>
<li class="chapter" data-level="6.1.7" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#control-acceleration-logging-0x0a"><i class="fa fa-check"></i><b>6.1.7</b> Control acceleration logging (<code>0x0A</code>)</a></li>
<li class="chapter" data-level="6.1.8" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#query-status-of-acceleration-logging-0x0b"><i class="fa fa-check"></i><b>6.1.8</b> Query status of acceleration logging (<code>0x0B</code>)</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#response-messages"><i class="fa fa-check"></i><b>6.2</b> Response messages</a><ul>
<li class="chapter" data-level="6.2.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#status-response-0x00"><i class="fa fa-check"></i><b>6.2.1</b> Status response (<code>0x00</code>)</a></li>
<li class="chapter" data-level="6.2.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#end-of-data-message-0x03-0x05"><i class="fa fa-check"></i><b>6.2.2</b> End of data message (<code>0x03</code>, <code>0x05</code>)</a></li>
<li class="chapter" data-level="6.2.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#configuration-response-0x07"><i class="fa fa-check"></i><b>6.2.3</b> Configuration response (<code>0x07</code>)</a></li>
<li class="chapter" data-level="6.2.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#timestamp-response-0x09"><i class="fa fa-check"></i><b>6.2.4</b> Timestamp response (<code>0x09</code>)</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#data-message"><i class="fa fa-check"></i><b>6.3</b> Data message</a><ul>
<li class="chapter" data-level="6.3.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format"><i class="fa fa-check"></i><b>6.3.1</b> 12 bit data format</a></li>
<li class="chapter" data-level="6.3.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format-1"><i class="fa fa-check"></i><b>6.3.2</b> 10 bit data format</a></li>
<li class="chapter" data-level="6.3.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format-2"><i class="fa fa-check"></i><b>6.3.3</b> 8 bit data format</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#communication-example"><i class="fa fa-check"></i><b>6.4</b> Communication example</a></li>
</ul></li>
<li class="part"><span><b>To Do</b></span></li>
<li class="chapter" data-level="7" data-path="sensor-1.html"><a href="sensor-1.html"><i class="fa fa-check"></i><b>7</b> Sensor</a><ul>
<li class="chapter" data-level="7.1" data-path="sensor-1.html"><a href="sensor-1.html#hardware"><i class="fa fa-check"></i><b>7.1</b> Hardware</a><ul>
<li class="chapter" data-level="7.1.1" data-path="sensor-1.html"><a href="sensor-1.html#external-flash-memory"><i class="fa fa-check"></i><b>7.1.1</b> External Flash Memory</a></li>
<li class="chapter" data-level="7.1.2" data-path="sensor-1.html"><a href="sensor-1.html#board-redesign"><i class="fa fa-check"></i><b>7.1.2</b> Board Redesign</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="sensor-1.html"><a href="sensor-1.html#software"><i class="fa fa-check"></i><b>7.2</b> Software</a><ul>
<li class="chapter" data-level="7.2.1" data-path="sensor-1.html"><a href="sensor-1.html#implementation-1"><i class="fa fa-check"></i><b>7.2.1</b> Implementation</a></li>
<li class="chapter" data-level="7.2.2" data-path="sensor-1.html"><a href="sensor-1.html#general-todo"><i class="fa fa-check"></i><b>7.2.2</b> General ToDo</a></li>
<li class="chapter" data-level="7.2.3" data-path="sensor-1.html"><a href="sensor-1.html#security"><i class="fa fa-check"></i><b>7.2.3</b> Security</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="gateway-1.html"><a href="gateway-1.html"><i class="fa fa-check"></i><b>8</b> Gateway</a><ul>
<li class="chapter" data-level="8.1" data-path="gateway-1.html"><a href="gateway-1.html#hardware-1"><i class="fa fa-check"></i><b>8.1</b> Hardware</a><ul>
<li class="chapter" data-level="8.1.1" data-path="gateway-1.html"><a href="gateway-1.html#uninterruptible-power-supply"><i class="fa fa-check"></i><b>8.1.1</b> Uninterruptible Power Supply</a></li>
<li class="chapter" data-level="8.1.2" data-path="gateway-1.html"><a href="gateway-1.html#camera"><i class="fa fa-check"></i><b>8.1.2</b> Camera</a></li>
<li class="chapter" data-level="8.1.3" data-path="gateway-1.html"><a href="gateway-1.html#g4g5g-module"><i class="fa fa-check"></i><b>8.1.3</b> 3g/4g/5g Module</a></li>
<li class="chapter" data-level="8.1.4" data-path="gateway-1.html"><a href="gateway-1.html#bluetooth-hardware"><i class="fa fa-check"></i><b>8.1.4</b> Bluetooth Hardware</a></li>
<li class="chapter" data-level="8.1.5" data-path="gateway-1.html"><a href="gateway-1.html#case"><i class="fa fa-check"></i><b>8.1.5</b> Case</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="gateway-1.html"><a href="gateway-1.html#software-1"><i class="fa fa-check"></i><b>8.2</b> Software</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="backend-1.html"><a href="backend-1.html"><i class="fa fa-check"></i><b>9</b> Backend</a></li>
<li class="part"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html"><i class="fa fa-check"></i>Contributors</a><ul>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html#ws-2020-2021"><i class="fa fa-check"></i>WS 2020 / 2021</a></li>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html#ss-2021"><i class="fa fa-check"></i>SS 2021</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="commerical-applications.html"><a href="commerical-applications.html"><i class="fa fa-check"></i>Commerical Applications</a><ul>
<li class="chapter" data-level="" data-path="commerical-applications.html"><a href="commerical-applications.html#literature"><i class="fa fa-check"></i>Literature</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="system-info.html"><a href="system-info.html"><i class="fa fa-check"></i>System Info</a></li>
<li class="divider"></li>
<li><a href="http://www.bchwtz.de" target="blank"><center>www.<b>BCHWTZ</b>.de</center></a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Big Data Case Studies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ble-gatt-messages" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> BLE GATT Messages</h1>
<p>Communication between Gateway and Sensor is done via Bluetooth Low Energy. It uses the Nordic UART service which itself uses the Bluetooth GATT protocol.</p>
<p>Three types of messages are used.</p>
<ol style="list-style-type: decimal">
<li>The Gateway sends control messages to the sensor to set or read configuration or start transmission of logged data.</li>
<li>The Sensor responds to control messages via response messages. This message type transports status information or configuration data.</li>
<li>If the Gateway requests the Sensor to send logged data, this data is sent by data messages. To transport all data many data messages are used in sequence. The end of data is signaled by a response message.</li>
</ol>
<p>The messages are differentiated by the first byte.</p>
<div id="control-messages" class="section level2">
<h2><span class="header-section-number">6.1</span> Control messages</h2>
<p>Control messages are indicated by the value <code>0xFA</code> in the first position. This byte is repeated in the second position. The type of the message is distinguished by the third byte. The general structure of a control message is show in the following table.</p>
<table>
<thead>
<tr class="header">
<th>Header</th>
<th>Header</th>
<th>Type</th>
<th>Parameter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>0xFA</code></td>
<td><code>0xFA</code></td>
<td>XX</td>
<td>Zero or more Parameter</td>
</tr>
</tbody>
</table>
<p>Control messages must be padded by nullbytes to a minimum length of 11 bytes. This requirement is introduced by the Ruuvi firmware. The padding bytes are not shown in the following description of the messages.</p>
<div id="start-transmitting-last-sample-0x03" class="section level3">
<h3><span class="header-section-number">6.1.1</span> Start transmitting last sample (<code>0x03</code>)</h3>
<p>This message starts transmitting the last sample of acceleration data. This sample consists of 32 tuples of (X,Y,Z) values. It is taken from RAM and transmitted to the gateway by using data messages. The transmission of the data is followed by a <a href="ble-gatt-messages.html#end-of-data-message-0x03-0x05">end of data message</a> which signals the end of the data.</p>
<p>This message takes no parameters. It’s concrete content is: <code>0xFA 0xFA 0x03</code>.</p>
<p>If acceleration logging is not active, the Sensor responds a <a href="ble-gatt-messages.html#status-response-0x00">status response</a> containing error code <code>RD_ERROR_INVALID_STATE</code>.</p>
</div>
<div id="start-transmitting-logged-data-0x05" class="section level3">
<h3><span class="header-section-number">6.1.2</span> Start transmitting logged data (<code>0x05</code>)</h3>
<p>This message starts transmitting the logged acceleration data from the ringbuffer. The data includes the last page which is not complete full and is not yet written to flash. The transmission of the data is followed by a <a href="ble-gatt-messages.html#end-of-data-message-0x03-0x05">end of data message</a> which signals the end of the data. After downloading the logged data, the ringbuffer is empty.</p>
<p>This message takes no parameters. Its concrete content is: <code>0xFA 0xFA 0x05</code>.</p>
<p>If acceleration logging is not active, the Sensor responds with a <a href="ble-gatt-messages.html#status-response-0x00">status response</a> containing error code <code>RD_ERROR_INVALID_STATE</code>.</p>
</div>
<div id="set-configuration-of-acceleration-sensor-0x06" class="section level3">
<h3><span class="header-section-number">6.1.3</span> Set configuration of acceleration sensor (<code>0x06</code>)</h3>
<p>This message is used to set the configuration of the acceleration sensor (LIS2DH12). The message takes 8 Parameters. The Sensor responds to this message with a <a href="ble-gatt-messages.html#status-response-0x00">status response</a>. The parameters are as follows.</p>
<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>P1</td>
<td>Rate of sampling in smaples per second. Allowed values are 1Hz, 10Hz, 25Hz, 50Hz, 100Hz, 200Hz, 400Hz.</td>
</tr>
<tr class="even">
<td>P2</td>
<td>Resolution in bits. Allowed values are 8, 10, 12.</td>
</tr>
<tr class="odd">
<td>P3</td>
<td>Measuring range. Allowed values are 2G, 4G, 8G, 16G.</td>
</tr>
<tr class="even">
<td>P4</td>
<td>DSP function. See datasheet of LIS2DH12.</td>
</tr>
<tr class="odd">
<td>P5</td>
<td>DSP parameter. See datasheet of LIS2DH12.</td>
</tr>
<tr class="even">
<td>P6</td>
<td>Mode of operation. Allowed values are <code>0xF2</code>, <code>0xF3</code>, <code>0xF4</code>. See ruuvi_driver_sensor.h for explanation.</td>
</tr>
<tr class="odd">
<td>P7</td>
<td>Reserved. Set to <code>0x00</code>.</td>
</tr>
<tr class="even">
<td>P8</td>
<td>Reserved. Set to <code>0x00</code>.</td>
</tr>
</tbody>
</table>
<p>All values from P1 to P6 can be set to <code>0xFF</code> which means ‘do not change this values’.</p>
<p>The concrete content of this message is <code>0xFA 0xFA 0x06 P1 P2 P3 P4 P5 P6 P7 P8</code>.</p>
</div>
<div id="read-configuration-of-acceleration-sensor-0x07" class="section level3">
<h3><span class="header-section-number">6.1.4</span> Read configuration of acceleration sensor (<code>0x07</code>)</h3>
<p>This message is used to read the configuration of the acceleration sensor (LIS2DH12). The message takes no parameters. The Sensor responds to this message by a <a href="ble-gatt-messages.html#configuration-response-0x07">response message which transmits the configuration</a>.</p>
<p>The concrete content of this message is: <code>0xFA 0xFA 0x07</code>.</p>
</div>
<div id="set-system-time-0x08" class="section level3">
<h3><span class="header-section-number">6.1.5</span> Set system time (<code>0x08</code>)</h3>
<p>This message is used to set the RTC of the sensor to a timestamp which is part of the message. The time is expressed in milliseconds. It must be transmitted in <a href="https://en.wikipedia.org/wiki/Endianness#Example">little-endian</a> byte sequence. The sensor responds to this message with a <a href="ble-gatt-messages.html#status-response-0x00">status response</a>.</p>
<p>The concrete content of this message is <code>0xFA 0xFA 0x08 XX XX XX XX XX XX XX XX</code>.</p>
</div>
<div id="read-system-time-0x09" class="section level3">
<h3><span class="header-section-number">6.1.6</span> Read system time (<code>0x09</code>)</h3>
<p>This message is used to read the RTC of the sensor. The sensor responds to this message with a <a href="ble-gatt-messages.html#timestamp-response-0x09">timestamp response</a>.</p>
<p>The concrete content of this message is <code>0xFA 0xFA 0x09</code>.</p>
</div>
<div id="control-acceleration-logging-0x0a" class="section level3">
<h3><span class="header-section-number">6.1.7</span> Control acceleration logging (<code>0x0A</code>)</h3>
<p>This message is used to activate or deactivate acceleration logging. It takes one parameter. The parameter is interpreted as a boolean value. If it maps to true, acceleration logging is activated. If it maps to false, acceleration logging is deactivated. The sensor responds to this message using a <a href="ble-gatt-messages.html#status-response-0x00">status response</a>. Activating acceleration logging when it is already active results in an error. Deactivating acceleration logging when it is not active results in an error.</p>
<p>The concrete content of this message is <code>0xFA 0xFA 0x0A XX</code>. Where <code>XX</code> can be <code>0x00</code> or <code>0x01</code>.</p>
</div>
<div id="query-status-of-acceleration-logging-0x0b" class="section level3">
<h3><span class="header-section-number">6.1.8</span> Query status of acceleration logging (<code>0x0B</code>)</h3>
<p>This message is used to query the status of acceleration logging. The sensor responds to this message with a <a href="ble-gatt-messages.html#status-response-0x00">status response</a>. If logging is active, the response contains the status <code>RD_SUCCESS</code> if logging is not active the status is <code>RD_ERROR_NOT_INITIALIZED</code>.</p>
<p>The concrete content of this message is <code>0xFA 0xFA 0x0B</code>.</p>
</div>
</div>
<div id="response-messages" class="section level2">
<h2><span class="header-section-number">6.2</span> Response messages</h2>
<p>Response messages are indicated by the value <code>0xFB</code> as the first byte. The type of the message is differentiated by the second byte. The general structure of a response message is show in the following table.</p>
<table>
<thead>
<tr class="header">
<th>Header</th>
<th>Type</th>
<th>status</th>
<th>Parameter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>0xFB</code></td>
<td>XX</td>
<td>status</td>
<td>Zero or more Parameter</td>
</tr>
</tbody>
</table>
<p>Every response message returns a status code as the result of the processing as the third byte. It must be interpreted as a bitfield. The bits represent the different error conditions. The following table show the error conditions. In case of mulpilte arrors more than one bit can be set. If no bit is set the processing was successful.</p>
<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>Value</th>
<th>Error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>status==0</td>
<td>RD_SUCCESS: No error</td>
</tr>
<tr class="even">
<td>1</td>
<td>RD_ERROR_INTERNAL: Internal Error</td>
</tr>
<tr class="odd">
<td>2</td>
<td>RD_ERROR_NO_MEM: No Memory for operation</td>
</tr>
<tr class="even">
<td>4</td>
<td>RD_ERROR_NOT_FOUND: Not found</td>
</tr>
<tr class="odd">
<td>8</td>
<td>RD_ERROR_NOT_SUPPORTED: Not supported</td>
</tr>
<tr class="even">
<td>16</td>
<td>RD_ERROR_INVALID_PARAM: Invalid Parameter</td>
</tr>
<tr class="odd">
<td>32</td>
<td>RD_ERROR_INVALID_status: Invalid status, operation disallowed in this status</td>
</tr>
<tr class="even">
<td>64</td>
<td>RD_ERROR_INVALID_LENGTH: Invalid Length</td>
</tr>
<tr class="odd">
<td>128</td>
<td>RD_ERROR_INVALID_FLAGS: Invalid Flags</td>
</tr>
<tr class="even">
<td>256</td>
<td>RD_ERROR_INVALID_DATA: Invalid Data</td>
</tr>
<tr class="odd">
<td>512</td>
<td>RD_ERROR_DATA_SIZE: Invalid Data size</td>
</tr>
<tr class="even">
<td>1024</td>
<td>RD_ERROR_TIMEOUT: Operation timed out</td>
</tr>
<tr class="odd">
<td>2048</td>
<td>RD_ERROR_NULL: Null Pointer</td>
</tr>
<tr class="even">
<td>4096</td>
<td>RD_ERROR_FORBIDDEN: Forbidden Operation</td>
</tr>
<tr class="odd">
<td>8192</td>
<td>RD_ERROR_INVALID_ADDR: Bad Memory Address</td>
</tr>
<tr class="even">
<td>16384</td>
<td>RD_ERROR_BUSY: Flash Busy</td>
</tr>
<tr class="odd">
<td>32768</td>
<td>RD_ERROR_RESOURCES: Not enough resources for operation</td>
</tr>
<tr class="even">
<td>65535</td>
<td>RD_ERROR_NOT_IMPLEMENTED: Not implemented yet</td>
</tr>
<tr class="odd">
<td>131072</td>
<td>RD_ERROR_SELFTEST: Self-test fail</td>
</tr>
<tr class="even">
<td>262144</td>
<td>RD_STATUS_MORE_AVAILABLE: Driver has more data queued</td>
</tr>
<tr class="odd">
<td>524288</td>
<td>RD_ERROR_NOT_INITIALIZED: Driver is not initialized.</td>
</tr>
<tr class="even">
<td>1048576</td>
<td>RD_ERROR_NOT_ACKNOWLEDGED: Ack was expected but not received</td>
</tr>
<tr class="odd">
<td>2097152</td>
<td>RD_ERROR_NOT_ENABLED: Driver is not enabled</td>
</tr>
</tbody>
</table>
<div id="status-response-0x00" class="section level3">
<h3><span class="header-section-number">6.2.1</span> Status response (<code>0x00</code>)</h3>
<p>This message is used to return a status code to the gateway if no other information is available.</p>
<p>The concrete content of this message is <code>0xFB 0x00 SS</code>. Where <code>SS</code> is the status code.</p>
</div>
<div id="end-of-data-message-0x03-0x05" class="section level3">
<h3><span class="header-section-number">6.2.2</span> End of data message (<code>0x03</code>, <code>0x05</code>)</h3>
<p>This message is sent to the gateway after returning data. It signals the end of the transmission. The type byte (<code>0x03</code>, <code>0x05</code>) maps to the type of data requested. This message contains nine parameters. The current configuration of the acceleration sensor are the first eight parameter. The structure is the same as shown in the <a href="ble-gatt-messages.html#set-configuration-of-acceleration-sensor-0x06">set configuration message</a>. The CRC16 value of the transmitted data is the 9th parameter.</p>
<p>To compute the CRC16 value the polynom <code>0x11021</code> with the initial value <code>0xFFFF</code> is used. The output bytes are not reversed and not XOR’d. The CRC value is of size 2 bytes. It is transfered in <a href="https://en.wikipedia.org/wiki/Endianness#Example">little-endian</a> byte sequence.</p>
<p>The concrete content of this message is <code>0xFB 0x03/0x05 SS P1 P2 P3 P4 P5 P6 P7 P8 CRC1 CRC2</code>.</p>
<p>Where <code>SS</code> is the status code.</p>
</div>
<div id="configuration-response-0x07" class="section level3">
<h3><span class="header-section-number">6.2.3</span> Configuration response (<code>0x07</code>)</h3>
<p>This message is sent to the gateway after requesting the current configuration. The message contains eight parameters containing the current configuration. If the status code signals an error the transmitted values is undefined.</p>
<p>The concrete content of this message is <code>0xFB 0x07 SS P1 P2 P3 P4 P5 P6 P7 P8</code>. The values P1 to P8 map to the same values as shown in <a href="ble-gatt-messages.html#set-configuration-of-acceleration-sensor-0x06">set configuration message</a>.</p>
<p>Where <code>SS</code> is the status code.</p>
</div>
<div id="timestamp-response-0x09" class="section level3">
<h3><span class="header-section-number">6.2.4</span> Timestamp response (<code>0x09</code>)</h3>
<p>This message is sent to the gateway after requesting the system time. The message contains one parameter. The parameter is a 8 byte value containing the current timestamp. The bytes are transferred in <a href="https://en.wikipedia.org/wiki/Endianness#Example">little-endian</a> sequence. If the status code signals an error the transmitted value is undefined.</p>
<p>The concrete content of this message is <code>0xFB 0x09 SS XX XX XX XX XX XX XX XX</code>. Where <code>SS</code> is the status code.</p>
</div>
</div>
<div id="data-message" class="section level2">
<h2><span class="header-section-number">6.3</span> Data message</h2>
<p>Data messages are used to transfer logged acceleration data. A data message starts with the byte <code>0xFC</code>. After the start byte there follows up to 19 bytes of data.</p>
<p>The concrete content of this message is <code>0xFC XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX</code>.</p>
<p>The data is returned in blocks of 32 tuples of x-, y-, z-values. Every block is preceded by the timestamp when the interrupt occured which this block generates. To decode the data block the information about the resolution and the scale is needed. This information is transmitted by the <a href="ble-gatt-messages.html#end-of-data-message-0x03-0x05">end of data message</a>. All values are transferred in <a href="https://en.wikipedia.org/wiki/Endianness#Example">little-endian</a> byte sequence.</p>
<p>After de-compacting every value must be interpreted as the most significant part of an 16 bit wide signed integer. To get the real acceleration value from this intermediate value multiply it by one of the following factors.</p>
<table>
<thead>
<tr class="header">
<th>Scale / Resolution</th>
<th>8 bit</th>
<th>10 bit</th>
<th>12 bit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2G</td>
<td><span class="math inline">\(\frac{16}{256*1000}\)</span></td>
<td><span class="math inline">\(\frac{4}{64*1000}\)</span></td>
<td><span class="math inline">\(\frac{1}{16*1000}\)</span></td>
</tr>
<tr class="even">
<td>4G</td>
<td><span class="math inline">\(\frac{32}{256*1000}\)</span></td>
<td><span class="math inline">\(\frac{8}{64*1000}\)</span></td>
<td><span class="math inline">\(\frac{2}{16*1000}\)</span></td>
</tr>
<tr class="odd">
<td>8G</td>
<td><span class="math inline">\(\frac{64}{256*1000}\)</span></td>
<td><span class="math inline">\(\frac{16}{64*1000}\)</span></td>
<td><span class="math inline">\(\frac{4}{16*1000}\)</span></td>
</tr>
<tr class="even">
<td>16G</td>
<td><span class="math inline">\(\frac{192}{256*1000}\)</span></td>
<td><span class="math inline">\(\frac{48}{64*1000}\)</span></td>
<td><span class="math inline">\(\frac{12}{16*1000}\)</span></td>
</tr>
</tbody>
</table>
<div id="bit-data-format" class="section level3">
<h3><span class="header-section-number">6.3.1</span> 12 bit data format</h3>
<p>In 12 bit resolution mode two values are transmitted inside 3 bytes. See following figure.</p>
<p><img src="gfx/org/bitpack12.png" /></p>
</div>
<div id="bit-data-format-1" class="section level3">
<h3><span class="header-section-number">6.3.2</span> 10 bit data format</h3>
<p>In 10 bit resolution mode four values are transmitted inside 5 bytes. See following figure.</p>
<p><img src="gfx/org/bitpack10.png" /></p>
</div>
<div id="bit-data-format-2" class="section level3">
<h3><span class="header-section-number">6.3.3</span> 8 bit data format</h3>
<p>In 8 bit resolution mode every value is transmitted seperatly. See following figure.</p>
<p><img src="gfx/org/bitpack8.png" /></p>
</div>
</div>
<div id="communication-example" class="section level2">
<h2><span class="header-section-number">6.4</span> Communication example</h2>
<p>The following figure shows an example communication.</p>
<p><img src="gfx/org/GATT-communication-example.png" /></p>

</div>
</div>



</div>
            </section>

          </div>
        </div>
      </div>
<a href="backend.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sensor-1.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/14-docs-messages.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bchwtz-bdcs.pdf", "bchwtz-bdcs.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
