<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Sensor | Big Data Case Studies</title>
  <meta name="description" content="Chapter 6 Sensor | Big Data Case Studies" />
  <meta name="generator" content="bookdown 0.25 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Sensor | Big Data Case Studies" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Chapter 6 Sensor | Big Data Case Studies" />
  <meta name="github-repo" content="bchwtz/bchwtz-bdcs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Sensor | Big Data Case Studies" />
  
  <meta name="twitter:description" content="Chapter 6 Sensor | Big Data Case Studies" />
  

<meta name="author" content="Benjamin Buchwitz" />


<meta name="date" content="2022-03-31" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="getting-started-package.html"/>
<link rel="next" href="external-flash-integration.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><b>Big Data Case Studies</b></a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction<span></span></a></li>
<li class="chapter" data-level="2" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>2</b> Getting Started<span></span></a><ul>
<li class="chapter" data-level="2.1" data-path="getting-started.html"><a href="getting-started.html#sensor-dev-env"><i class="fa fa-check"></i><b>2.1</b> Sensor Dev Env<span></span></a><ul>
<li class="chapter" data-level="2.1.1" data-path="getting-started.html"><a href="getting-started.html#software-setup"><i class="fa fa-check"></i><b>2.1.1</b> Software Setup<span></span></a></li>
<li class="chapter" data-level="2.1.2" data-path="getting-started.html"><a href="getting-started.html#hardware-setup"><i class="fa fa-check"></i><b>2.1.2</b> Hardware Setup<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="getting-started.html"><a href="getting-started.html#gateway-dev-env"><i class="fa fa-check"></i><b>2.2</b> Gateway Dev Env<span></span></a><ul>
<li class="chapter" data-level="2.2.1" data-path="getting-started.html"><a href="getting-started.html#raspberry-connection-via-screen"><i class="fa fa-check"></i><b>2.2.1</b> Raspberry connection via screen<span></span></a></li>
<li class="chapter" data-level="2.2.2" data-path="getting-started.html"><a href="getting-started.html#raspberry-connection-without-a-screen-headless-setup"><i class="fa fa-check"></i><b>2.2.2</b> Raspberry connection without a screen (headless setup)<span></span></a></li>
<li class="chapter" data-level="2.2.3" data-path="getting-started.html"><a href="getting-started.html#set-up-putty-and-finalize-connection-to-raspberry"><i class="fa fa-check"></i><b>2.2.3</b> Set up PuTTY and finalize connection to Raspberry<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setup-a-jupyterhub-on-your-raspberrypi.html"><a href="setup-a-jupyterhub-on-your-raspberrypi.html"><i class="fa fa-check"></i><b>3</b> Setup a Jupyterhub on your RaspberryPi<span></span></a><ul>
<li class="chapter" data-level="3.1" data-path="setup-a-jupyterhub-on-your-raspberrypi.html"><a href="setup-a-jupyterhub-on-your-raspberrypi.html#prepare-python-environment"><i class="fa fa-check"></i><b>3.1</b> Prepare Python environment<span></span></a></li>
<li class="chapter" data-level="3.2" data-path="setup-a-jupyterhub-on-your-raspberrypi.html"><a href="setup-a-jupyterhub-on-your-raspberrypi.html#install-jupyterhub"><i class="fa fa-check"></i><b>3.2</b> Install JupyterHub<span></span></a></li>
<li class="chapter" data-level="3.3" data-path="setup-a-jupyterhub-on-your-raspberrypi.html"><a href="setup-a-jupyterhub-on-your-raspberrypi.html#configure-jupyterhub-as-a-system-service"><i class="fa fa-check"></i><b>3.3</b> Configure JupyterHub as a system service<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pycharm.html"><a href="pycharm.html"><i class="fa fa-check"></i><b>4</b> PyCharm<span></span></a><ul>
<li class="chapter" data-level="4.1" data-path="pycharm.html"><a href="pycharm.html#pycharm-git-repository"><i class="fa fa-check"></i><b>4.1</b> PyCharm Git Repository<span></span></a></li>
<li class="chapter" data-level="4.2" data-path="pycharm.html"><a href="pycharm.html#remotedeploy"><i class="fa fa-check"></i><b>4.2</b> RemoteDeploy<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="getting-started-package.html"><a href="getting-started-package.html"><i class="fa fa-check"></i><b>5</b> Getting Started Package<span></span></a><ul>
<li class="chapter" data-level="5.1" data-path="getting-started-package.html"><a href="getting-started-package.html#raspbery-pi-os-buster"><i class="fa fa-check"></i><b>5.1</b> Raspbery Pi OS “Buster”<span></span></a></li>
<li class="chapter" data-level="5.2" data-path="getting-started-package.html"><a href="getting-started-package.html#board"><i class="fa fa-check"></i><b>5.2</b> Board<span></span></a><ul>
<li class="chapter" data-level="5.2.1" data-path="getting-started-package.html"><a href="getting-started-package.html#raspberry-pi-4---model-b"><i class="fa fa-check"></i><b>5.2.1</b> Raspberry Pi 4 - Model B<span></span></a></li>
<li class="chapter" data-level="5.2.2" data-path="getting-started-package.html"><a href="getting-started-package.html#compute-model-4"><i class="fa fa-check"></i><b>5.2.2</b> Compute Model 4<span></span></a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>Documentation<span></span></b></span></li>
<li class="chapter" data-level="6" data-path="sensor.html"><a href="sensor.html"><i class="fa fa-check"></i><b>6</b> Sensor<span></span></a><ul>
<li class="chapter" data-level="6.1" data-path="sensor.html"><a href="sensor.html#initializing-acceleration-logging"><i class="fa fa-check"></i><b>6.1</b> Initializing acceleration logging<span></span></a></li>
<li class="chapter" data-level="6.2" data-path="sensor.html"><a href="sensor.html#retrieving-data-from-fifo"><i class="fa fa-check"></i><b>6.2</b> Retrieving data from FIFO<span></span></a></li>
<li class="chapter" data-level="6.3" data-path="sensor.html"><a href="sensor.html#using-the-data-by-heartbeat"><i class="fa fa-check"></i><b>6.3</b> Using the data by heartbeat<span></span></a></li>
<li class="chapter" data-level="6.4" data-path="sensor.html"><a href="sensor.html#initialization-during-boot"><i class="fa fa-check"></i><b>6.4</b> Initialization during boot<span></span></a></li>
<li class="chapter" data-level="6.5" data-path="sensor.html"><a href="sensor.html#streaming-of-acceleration-data"><i class="fa fa-check"></i><b>6.5</b> Streaming of acceleration data<span></span></a></li>
<li class="chapter" data-level="6.6" data-path="sensor.html"><a href="sensor.html#saving-the-config-inside-the-flashdb"><i class="fa fa-check"></i><b>6.6</b> Saving the config inside the flashdb<span></span></a></li>
<li class="chapter" data-level="6.7" data-path="sensor.html"><a href="sensor.html#heartbeat"><i class="fa fa-check"></i><b>6.7</b> Heartbeat<span></span></a></li>
<li class="chapter" data-level="6.8" data-path="sensor.html"><a href="sensor.html#implementation"><i class="fa fa-check"></i><b>6.8</b> Implementation<span></span></a><ul>
<li class="chapter" data-level="6.8.1" data-path="sensor.html"><a href="sensor.html#app_heartbeat.c"><i class="fa fa-check"></i><b>6.8.1</b> app_heartbeat.c<span></span></a></li>
<li class="chapter" data-level="6.8.2" data-path="sensor.html"><a href="sensor.html#ruuvi_task_sensor.c"><i class="fa fa-check"></i><b>6.8.2</b> ruuvi_task_sensor.c<span></span></a></li>
<li class="chapter" data-level="6.8.3" data-path="sensor.html"><a href="sensor.html#app_comms.c"><i class="fa fa-check"></i><b>6.8.3</b> app_comms.c<span></span></a></li>
<li class="chapter" data-level="6.8.4" data-path="sensor.html"><a href="sensor.html#ruuvi_nrf5_sdk15_communication_ble_gatt.c"><i class="fa fa-check"></i><b>6.8.4</b> ruuvi_nrf5_sdk15_communication_ble_gatt.c<span></span></a></li>
<li class="chapter" data-level="6.8.5" data-path="sensor.html"><a href="sensor.html#app_config.h"><i class="fa fa-check"></i><b>6.8.5</b> app_config.h<span></span></a></li>
<li class="chapter" data-level="6.8.6" data-path="sensor.html"><a href="sensor.html#app_sensor.c"><i class="fa fa-check"></i><b>6.8.6</b> app_sensor.c<span></span></a></li>
<li class="chapter" data-level="6.8.7" data-path="sensor.html"><a href="sensor.html#main.c"><i class="fa fa-check"></i><b>6.8.7</b> main.c<span></span></a></li>
<li class="chapter" data-level="6.8.8" data-path="sensor.html"><a href="sensor.html#ruuvi_interface_lis2dh12.c"><i class="fa fa-check"></i><b>6.8.8</b> ruuvi_interface_lis2dh12.c<span></span></a></li>
<li class="chapter" data-level="6.8.9" data-path="sensor.html"><a href="sensor.html#ruuvi_nrf5_sdk_rtc_mcu.c"><i class="fa fa-check"></i><b>6.8.9</b> ruuvi_nrf5_sdk_rtc_mcu.c<span></span></a></li>
<li class="chapter" data-level="6.8.10" data-path="sensor.html"><a href="sensor.html#ruuvi_nrf5_sdk15_power.c-ruuvi_nrf5_sdk15_power.h"><i class="fa fa-check"></i><b>6.8.10</b> ruuvi_nrf5_sdk15_power.c / ruuvi_nrf5_sdk15_power.h<span></span></a></li>
<li class="chapter" data-level="6.8.11" data-path="sensor.html"><a href="sensor.html#ruuvi_task_flash_ringbuffer.c"><i class="fa fa-check"></i><b>6.8.11</b> ruuvi_task_flash_ringbuffer.c<span></span></a></li>
<li class="chapter" data-level="6.8.12" data-path="sensor.html"><a href="sensor.html#ruuvi_task_flashdb.c"><i class="fa fa-check"></i><b>6.8.12</b> ruuvi_task_flashdb.c<span></span></a></li>
<li class="chapter" data-level="6.8.13" data-path="sensor.html"><a href="sensor.html#app_button.c"><i class="fa fa-check"></i><b>6.8.13</b> app_button.c<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="sensor.html"><a href="sensor.html#energy-consumption"><i class="fa fa-check"></i><b>6.9</b> Energy consumption<span></span></a></li>
<li class="chapter" data-level="6.10" data-path="sensor.html"><a href="sensor.html#firmware-packaging"><i class="fa fa-check"></i><b>6.10</b> Firmware packaging<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="external-flash-integration.html"><a href="external-flash-integration.html"><i class="fa fa-check"></i><b>7</b> External Flash Integration<span></span></a><ul>
<li class="chapter" data-level="7.1" data-path="external-flash-integration.html"><a href="external-flash-integration.html#macronix-flash"><i class="fa fa-check"></i><b>7.1</b> Macronix Flash<span></span></a></li>
<li class="chapter" data-level="7.2" data-path="external-flash-integration.html"><a href="external-flash-integration.html#database-vs.-filesystem"><i class="fa fa-check"></i><b>7.2</b> Database vs. Filesystem<span></span></a><ul>
<li class="chapter" data-level="7.2.1" data-path="external-flash-integration.html"><a href="external-flash-integration.html#flashdb"><i class="fa fa-check"></i><b>7.2.1</b> FlashDB <img src="gfx/org/flashdb.png" /><span></span></a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="external-flash-integration.html"><a href="external-flash-integration.html#implementation-1"><i class="fa fa-check"></i><b>7.3</b> Implementation<span></span></a><ul>
<li class="chapter" data-level="7.3.1" data-path="external-flash-integration.html"><a href="external-flash-integration.html#flashdb-api"><i class="fa fa-check"></i><b>7.3.1</b> FlashDB API<span></span></a></li>
<li class="chapter" data-level="7.3.2" data-path="external-flash-integration.html"><a href="external-flash-integration.html#data-base-config-files"><i class="fa fa-check"></i><b>7.3.2</b> Data Base config files<span></span></a></li>
<li class="chapter" data-level="7.3.3" data-path="external-flash-integration.html"><a href="external-flash-integration.html#macronix-low-level-driver-functions"><i class="fa fa-check"></i><b>7.3.3</b> Macronix low level driver functions<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="external-flash-integration.html"><a href="external-flash-integration.html#flashdb-evaluation"><i class="fa fa-check"></i><b>7.4</b> FlashDB evaluation<span></span></a><ul>
<li class="chapter" data-level="7.4.1" data-path="external-flash-integration.html"><a href="external-flash-integration.html#amount-of-data-wich-can-be-stored"><i class="fa fa-check"></i><b>7.4.1</b> Amount of data wich can be stored<span></span></a></li>
<li class="chapter" data-level="7.4.2" data-path="external-flash-integration.html"><a href="external-flash-integration.html#energy-consumption-1"><i class="fa fa-check"></i><b>7.4.2</b> Energy consumption<span></span></a></li>
<li class="chapter" data-level="7.4.3" data-path="external-flash-integration.html"><a href="external-flash-integration.html#github-issue-11-write-performance-on-external-flash"><i class="fa fa-check"></i><b>7.4.3</b> GitHub Issue #11 Write Performance on External Flash<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="gateway.html"><a href="gateway.html"><i class="fa fa-check"></i><b>8</b> Gateway<span></span></a><ul>
<li class="chapter" data-level="8.1" data-path="gateway.html"><a href="gateway.html#sensor-gateway-communication-library"><i class="fa fa-check"></i><b>8.1</b> Sensor Gateway Communication Library<span></span></a><ul>
<li class="chapter" data-level="8.1.1" data-path="gateway.html"><a href="gateway.html#activate-acceleration-logging"><i class="fa fa-check"></i><b>8.1.1</b> Activate acceleration logging<span></span></a></li>
<li class="chapter" data-level="8.1.2" data-path="gateway.html"><a href="gateway.html#deactivate-acceleration-logging"><i class="fa fa-check"></i><b>8.1.2</b> Deactivate acceleration logging<span></span></a></li>
<li class="chapter" data-level="8.1.3" data-path="gateway.html"><a href="gateway.html#set-sensor-configuration"><i class="fa fa-check"></i><b>8.1.3</b> Set sensor configuration<span></span></a></li>
<li class="chapter" data-level="8.1.4" data-path="gateway.html"><a href="gateway.html#set-sensor-time"><i class="fa fa-check"></i><b>8.1.4</b> Set sensor time<span></span></a></li>
<li class="chapter" data-level="8.1.5" data-path="gateway.html"><a href="gateway.html#get-sensor-configuration"><i class="fa fa-check"></i><b>8.1.5</b> Get sensor configuration<span></span></a></li>
<li class="chapter" data-level="8.1.6" data-path="gateway.html"><a href="gateway.html#get-sensor-time"><i class="fa fa-check"></i><b>8.1.6</b> Get sensor time<span></span></a></li>
<li class="chapter" data-level="8.1.7" data-path="gateway.html"><a href="gateway.html#get-acceleration-data"><i class="fa fa-check"></i><b>8.1.7</b> Get acceleration data<span></span></a></li>
<li class="chapter" data-level="8.1.8" data-path="gateway.html"><a href="gateway.html#get-flash-statistics"><i class="fa fa-check"></i><b>8.1.8</b> Get flash statistics<span></span></a></li>
<li class="chapter" data-level="8.1.9" data-path="gateway.html"><a href="gateway.html#get-logging-status"><i class="fa fa-check"></i><b>8.1.9</b> Get logging status<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="gateway.html"><a href="gateway.html#advertisement-logging"><i class="fa fa-check"></i><b>8.2</b> Advertisement logging<span></span></a></li>
<li class="chapter" data-level="8.3" data-path="gateway.html"><a href="gateway.html#data-storage-format"><i class="fa fa-check"></i><b>8.3</b> Data storage format<span></span></a><ul>
<li class="chapter" data-level="8.3.1" data-path="gateway.html"><a href="gateway.html#csv-file-acceleration-logging"><i class="fa fa-check"></i><b>8.3.1</b> Csv file acceleration Logging<span></span></a></li>
<li class="chapter" data-level="8.3.2" data-path="gateway.html"><a href="gateway.html#csv-file-advertisement-logging"><i class="fa fa-check"></i><b>8.3.2</b> Csv file advertisement Logging<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="backend.html"><a href="backend.html"><i class="fa fa-check"></i><b>9</b> Backend<span></span></a></li>
<li class="chapter" data-level="10" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html"><i class="fa fa-check"></i><b>10</b> BLE GATT Messages<span></span></a><ul>
<li class="chapter" data-level="10.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#general-message-structure"><i class="fa fa-check"></i><b>10.1</b> General message structure<span></span></a></li>
<li class="chapter" data-level="10.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#control-messages"><i class="fa fa-check"></i><b>10.2</b> Control messages<span></span></a><ul>
<li class="chapter" data-level="10.2.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#set-heartbeat"><i class="fa fa-check"></i><b>10.2.1</b> Set heartbeat<span></span></a></li>
<li class="chapter" data-level="10.2.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#get-heartbeat"><i class="fa fa-check"></i><b>10.2.2</b> Get heartbeat<span></span></a></li>
<li class="chapter" data-level="10.2.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#start-transmitting-acceleration-data"><i class="fa fa-check"></i><b>10.2.3</b> Start transmitting acceleration data<span></span></a></li>
<li class="chapter" data-level="10.2.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#set-configuration-of-acceleration-sensor"><i class="fa fa-check"></i><b>10.2.4</b> Set configuration of acceleration sensor<span></span></a></li>
<li class="chapter" data-level="10.2.5" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#read-configuration-of-acceleration-sensor"><i class="fa fa-check"></i><b>10.2.5</b> Read configuration of acceleration sensor<span></span></a></li>
<li class="chapter" data-level="10.2.6" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#set-system-time"><i class="fa fa-check"></i><b>10.2.6</b> Set system time<span></span></a></li>
<li class="chapter" data-level="10.2.7" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#read-system-time"><i class="fa fa-check"></i><b>10.2.7</b> Read system time<span></span></a></li>
<li class="chapter" data-level="10.2.8" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#control-acceleration-logging"><i class="fa fa-check"></i><b>10.2.8</b> Control acceleration logging<span></span></a></li>
<li class="chapter" data-level="10.2.9" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#query-status-of-acceleration-logging"><i class="fa fa-check"></i><b>10.2.9</b> Query status of acceleration logging<span></span></a></li>
<li class="chapter" data-level="10.2.10" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#query-flash-statistic"><i class="fa fa-check"></i><b>10.2.10</b> Query flash statistic<span></span></a></li>
<li class="chapter" data-level="10.2.11" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#query-boot-counter"><i class="fa fa-check"></i><b>10.2.11</b> Query boot counter<span></span></a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#response-messages"><i class="fa fa-check"></i><b>10.3</b> Response messages<span></span></a><ul>
<li class="chapter" data-level="10.3.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#status-response"><i class="fa fa-check"></i><b>10.3.1</b> Status response<span></span></a></li>
<li class="chapter" data-level="10.3.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#end-of-data-message"><i class="fa fa-check"></i><b>10.3.2</b> End of data message<span></span></a></li>
<li class="chapter" data-level="10.3.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#configuration-response"><i class="fa fa-check"></i><b>10.3.3</b> Configuration response<span></span></a></li>
<li class="chapter" data-level="10.3.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#timestamp-response"><i class="fa fa-check"></i><b>10.3.4</b> Timestamp response<span></span></a></li>
<li class="chapter" data-level="10.3.5" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#flash-statistic-response"><i class="fa fa-check"></i><b>10.3.5</b> Flash statistic response<span></span></a></li>
<li class="chapter" data-level="10.3.6" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#boot-counter-response"><i class="fa fa-check"></i><b>10.3.6</b> boot counter response<span></span></a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#data-message"><i class="fa fa-check"></i><b>10.4</b> Data message<span></span></a><ul>
<li class="chapter" data-level="10.4.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format"><i class="fa fa-check"></i><b>10.4.1</b> 12 bit data format<span></span></a></li>
<li class="chapter" data-level="10.4.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format-1"><i class="fa fa-check"></i><b>10.4.2</b> 10 bit data format<span></span></a></li>
<li class="chapter" data-level="10.4.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format-2"><i class="fa fa-check"></i><b>10.4.3</b> 8 bit data format<span></span></a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#communication-example"><i class="fa fa-check"></i><b>10.5</b> Communication example<span></span></a></li>
<li class="chapter" data-level="10.6" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#streaming"><i class="fa fa-check"></i><b>10.6</b> Streaming<span></span></a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="messageobjects.html"><a href="messageobjects.html"><i class="fa fa-check"></i><b>11</b> MessageObjects<span></span></a><ul>
<li class="chapter" data-level="11.1" data-path="messageobjects.html"><a href="messageobjects.html#return_values_from_sensor"><i class="fa fa-check"></i><b>11.1</b> return_values_from_sensor<span></span></a></li>
<li class="chapter" data-level="11.2" data-path="messageobjects.html"><a href="messageobjects.html#send_msg_object"><i class="fa fa-check"></i><b>11.2</b> send_msg_object<span></span></a></li>
</ul></li>
<li class="part"><span><b>To Do<span></span></b></span></li>
<li class="chapter" data-level="12" data-path="sensor-1.html"><a href="sensor-1.html"><i class="fa fa-check"></i><b>12</b> Sensor<span></span></a><ul>
<li class="chapter" data-level="12.1" data-path="sensor-1.html"><a href="sensor-1.html#hardware"><i class="fa fa-check"></i><b>12.1</b> Hardware<span></span></a><ul>
<li class="chapter" data-level="12.1.1" data-path="sensor-1.html"><a href="sensor-1.html#external-flash-memory"><i class="fa fa-check"></i><b>12.1.1</b> External Flash Memory<span></span></a></li>
<li class="chapter" data-level="12.1.2" data-path="sensor-1.html"><a href="sensor-1.html#board-redesign"><i class="fa fa-check"></i><b>12.1.2</b> Board Redesign<span></span></a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="sensor-1.html"><a href="sensor-1.html#software"><i class="fa fa-check"></i><b>12.2</b> Software<span></span></a><ul>
<li class="chapter" data-level="12.2.1" data-path="sensor-1.html"><a href="sensor-1.html#general-todo"><i class="fa fa-check"></i><b>12.2.1</b> General ToDo<span></span></a></li>
<li class="chapter" data-level="12.2.2" data-path="sensor-1.html"><a href="sensor-1.html#security"><i class="fa fa-check"></i><b>12.2.2</b> Security<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="gateway-1.html"><a href="gateway-1.html"><i class="fa fa-check"></i><b>13</b> Gateway<span></span></a><ul>
<li class="chapter" data-level="13.1" data-path="gateway-1.html"><a href="gateway-1.html#hardware-1"><i class="fa fa-check"></i><b>13.1</b> Hardware<span></span></a><ul>
<li class="chapter" data-level="13.1.1" data-path="gateway-1.html"><a href="gateway-1.html#uninterruptible-power-supply"><i class="fa fa-check"></i><b>13.1.1</b> Uninterruptible Power Supply<span></span></a></li>
<li class="chapter" data-level="13.1.2" data-path="gateway-1.html"><a href="gateway-1.html#camera"><i class="fa fa-check"></i><b>13.1.2</b> Camera<span></span></a></li>
<li class="chapter" data-level="13.1.3" data-path="gateway-1.html"><a href="gateway-1.html#g4g5g-module"><i class="fa fa-check"></i><b>13.1.3</b> 3g/4g/5g Module<span></span></a></li>
<li class="chapter" data-level="13.1.4" data-path="gateway-1.html"><a href="gateway-1.html#bluetooth-hardware"><i class="fa fa-check"></i><b>13.1.4</b> Bluetooth Hardware<span></span></a></li>
<li class="chapter" data-level="13.1.5" data-path="gateway-1.html"><a href="gateway-1.html#case"><i class="fa fa-check"></i><b>13.1.5</b> Case<span></span></a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="gateway-1.html"><a href="gateway-1.html#software-1"><i class="fa fa-check"></i><b>13.2</b> Software<span></span></a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="backend-1.html"><a href="backend-1.html"><i class="fa fa-check"></i><b>14</b> Backend<span></span></a></li>
<li class="part"><span><b>Appendix<span></span></b></span></li>
<li><a href="contributors.html#contributors">Contributors<span></span></a><ul>
<li><a href="contributors.html#ws-2020-2021">WS 2020 / 2021<span></span></a></li>
<li><a href="contributors.html#ss-2021">SS 2021<span></span></a></li>
<li><a href="contributors.html#ws-2021-2022">WS 2021 / 2022<span></span></a></li>
</ul></li>
<li><a href="commerical-applications.html#commerical-applications">Commerical Applications<span></span></a><ul>
<li><a href="commerical-applications.html#literature">Literature<span></span></a></li>
<li class="chapter" data-level="14.1" data-path="commerical-applications.html"><a href="commerical-applications.html"><i class="fa fa-check"></i><b>14.1</b> Merging<span></span></a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="caveates.html"><a href="caveates.html"><i class="fa fa-check"></i><b>15</b> Caveates<span></span></a></li>
<li class="chapter" data-level="16" data-path="dontt-do-feature-master.html"><a href="dontt-do-feature-master.html"><i class="fa fa-check"></i><b>16</b> DONT’T DO : feature =&gt; master<span></span></a></li>
<li class="chapter" data-level="17" data-path="do-master-feature-master.html"><a href="do-master-feature-master.html"><i class="fa fa-check"></i><b>17</b> DO : master =&gt; feature =&gt; master<span></span></a></li>
<li><a href="system-info.html#system-info">System Info<span></span></a></li>
<li class="divider"></li>
<li><a href="http://www.bchwtz.de" target="blank"><center>www.<b>BCHWTZ</b>.de</center></a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Big Data Case Studies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sensor" class="section level1 hasAnchor">
<h1><span class="header-section-number">Chapter 6</span> Sensor<a href="sensor.html#sensor" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The following figure shows the high level architecture of acceleration data logging in Ruuvi Tag. All configuration is done via the gateway. It communicates with the Ruuvi Tag using the Nordic UART interface via GATT messages transported by Bluetooth Low Energy (BLE). Most logic regarding acceleration logging is implemented inside the module <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a>.</p>
<p><img src="gfx/org/wrapping_of_data_get.png" /></p>
<p>Three use cases are shown in this figure.</p>
<div id="initializing-acceleration-logging" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.1</span> Initializing acceleration logging<a href="sensor.html#initializing-acceleration-logging" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The initialization is shown with blue arrows and numbers in black circles until #4.</p>
<p>To activate acceleration logging the gateway sends the <a href="ble-gatt-messages.html#control-acceleration-logging">control acceleration logging message</a>. In general GATT messages are handled by the function <a href="sensor.html#void-handle_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_comms()</code></a> inside the module <a href="sensor.html#app_comms.c">app_comm.c</a>. Messages regarding acceleration logging are delegated to the function <a href="sensor.html#rd_status_t-handle_lis2dh12_comms_v2-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_lis2dh12_comms_v2()</code></a> inside the same module. After receiving the message to activate acceleration logging the function <a href="sensor.html#rd_status_t-app_enable_sensor_loggingconst-bool-use_ram_db-const-bool-format_db"><code>app_enable_sensor_logging()</code></a> inside the module <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a> in called (1).</p>
<p>The first step in activation is to check if all conditions are fulfilled. The function returns an error code if acceleration logging is already active or if it is called on a sensor which does not include an LIS2DH12. This check is done by calling <a href="sensor.html#rt_sensor_ctx_t-app_sensor_find-const-char-name"><code>find_sensor()</code></a> inside of <a href="sensor.html#app_sensor.c">app_sensor.c</a> (2). This function returns the sensor context. The sensor context consists of several information about the sensor. The next step associates the function <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a> from <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a> with the interrupt pin retrieved from the sensor context (3). The last step is to activate FIFO and interrupt generation inside the LIS2DH12. This is done by calling two functions from the sensor context. At last the function pointer to <code>data_get()</code> inside the sensor context is replaced by the pointer to the function <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
</div>
<div id="retrieving-data-from-fifo" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.2</span> Retrieving data from FIFO<a href="sensor.html#retrieving-data-from-fifo" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When FIFO is full inside LIS2DH12 the interrupt starts the function <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a>. This function does not directly handle the new data. It schedules a call to <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>fifo_full_handler()</code></a>. Instead of <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a> this is called in the main thread of the application. If processing is done inside a function inside an interrupt context this prevents processing of another interrupt. This should be avoided.</p>
<p>Inside <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>fifo_full_handler()</code></a> the FIFO from LIS2DH12 is read (5). The values are store in memory in raw format to be ready to present them to the function <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a> which is important for heartbeat. In parallel the raw values are compacted by removing all unused bits. This is done by the function <a href="sensor.html#void-packconst-uint8_t-resolution-const-uint16_t-sizedata-const-uint8_t-const-data-uint8_t-const-packeddata"><code>pack()</code></a>. These values are handover to the FlashDB which writes them to flash (6).</p>
</div>
<div id="using-the-data-by-heartbeat" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.3</span> Using the data by heartbeat<a href="sensor.html#using-the-data-by-heartbeat" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This use case is shown with magenta arrows and numbers inside magenta circles in the figure above.</p>
<p>The heartbeat retrieves the values from all sensors by calling the function <code>app_sensor_get()</code> inside the module <a href="sensor.html#app_sensor.c">app_sensors.c</a>. In the original setup this function calls <a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data"><code>ri_lis2dh12_data_get()</code></a> inside <a href="sensor.html#ruuvi_interface_lis2dh12.c">ruuvi_interface_lis2dh12.c</a>. During initialization this function is replaced by <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
<p><a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a> retrieves the raw acceleration values from memory. Then the values are parsed by calling <a href="sensor.html#rd_status_t-ri_lis2dh12_raw_data_parse-rd_sensor_data_t-const-data-axis3bit16_t-raw_acceleration-uint8_t-raw_temperature"><code>ri_lis2dh12_raw_data_parse()</code></a> and returned to the heartbeat.</p>
</div>
<div id="initialization-during-boot" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.4</span> Initialization during boot<a href="sensor.html#initialization-during-boot" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>All sensor initialization is done inside <a href="sensor.html#void-setup-void"><code>setup()</code></a> from <a href="sensor.html#main.c">main.c</a>. This function calls <a href="sensor.html#rd_status_t-app_acc_logging_initvoid"><code>app_acc_logging_init()</code></a> inside <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a>. The function checks if the ringbuffer exists. If this is true it activates acceleration logging as described earlier.</p>
</div>
<div id="streaming-of-acceleration-data" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.5</span> Streaming of acceleration data<a href="sensor.html#streaming-of-acceleration-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In case of sampling acceleration data at high sampling frequencies than storing them in flash memory may be not possible because of latency of the memory or limitations by available size of memory. As an alternative the data can be streamed. In this mode, data from the acceleration sensor will not be written to flash. Instead the data is cached in RAM. For this purpose 6k RAM are dynamically allocated using <code>malloc()</code> during enabling of streaming. At the time of writing this documentation FlashDB lacks the feature of freeing memory which is used to store a database. Because of this missing feature the only way of freeing the memory used by streaming is to reboot the firmware.</p>
<p>The following figure shows the difference between logging of acceleration data and streaming.</p>
<p><img src="gfx/org/streaming_of_acceleration_data.png" />
When logging is active, the acceleration sensor LIS2DH12 generated an interrupt every time its FIFO is full. The interrupt causes the execution of <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a>. This function schedules the execution of <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>fifo_full_handler()</code></a> outside interrupt context (grey). The following process was described <a href="sensor.html#retrieving-data-from-fifo">earlier</a>.</p>
<p>When streaming is active, the process is started by the same condition. But the FIFO is read by <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a>. Instead of scheduling <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>fifo_full_handler()</code></a> the function hands over the data to FlashDB which stores them in RAM. This is done inside interrupt context (blue). In case of streaming there is no explicit command to read the data by the gateway. Instead, if connected to Bluetooth GATT service, the data is automatically send. This is done by scheduling <a href="sensor.html#void-app_acc_log_transfer_ram_db-void-p_event_data-uint16_t-event_size"><code>app_acc_log_transfer_ram_db()</code></a>. <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a> schedules execution of this function if <code>rt_gatt_nus_is_connected()</code> returns true.</p>
</div>
<div id="saving-the-config-inside-the-flashdb" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.6</span> Saving the config inside the flashdb<a href="sensor.html#saving-the-config-inside-the-flashdb" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To be able to report different sensor-config versions to the gateway, at different times, the current config is stored in the key-value-partition of the flashdb.
The configuration can be accessed via <code>rt_sensor_get_from_fdb</code> defined in <a href="sensor.html#ruuvi_task_sensor.c">ruuvi_task_sensor.c</a>.
The values will then be automatically loaded onto the sensor struct.
To save a config you will have to use <code>rt_sensor_store_to_fdb</code> defined in <a href="sensor.html#ruuvi_task_sensor.c">ruuvi_task_sensor.c</a>.</p>
</div>
<div id="heartbeat" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.7</span> Heartbeat<a href="sensor.html#heartbeat" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The heartbeat is an interval in which the sensor communicates via Bluetooth to the outside world. One of the most important facts about the heartbeat is that this is the only point in time a device can connect to the sensor. The default interval is around 800ms. However, the heartbeat can be get and set on sensor site with static methods <code>get_current_heartbeat()</code> and <code>app_heartbeat_start(uint16_t heartbeat_ms)</code> defined in <a href="sensor.html#app_heartbeat.c">app_heartbeat.c</a>.
Once the heartbeat is modified by hand (either from the sensor itself or from outside via Bluetooth messages) the new value is stored and will be applied directly and on every following reboot. Therefore it is advisable to be careful with modifying the heartbeat.</p>
</div>
<div id="implementation" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.8</span> Implementation<a href="sensor.html#implementation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="app_heartbeat.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.1</span> app_heartbeat.c<a href="sensor.html#app_heartbeat.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="uint16_t-get_current_heartbeatvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.1.1</span> <code>uint16_t get_current_heartbeat(void)</code><a href="sensor.html#uint16_t-get_current_heartbeatvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Get the current heartbeat.</p>
</div>
<div id="rd_status_t-app_heartbeat_stopvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.1.2</span> <code>rd_status_t app_heartbeat_stop(void)</code><a href="sensor.html#rd_status_t-app_heartbeat_stopvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Stop the heartbeat.
Note: This method should always be called before <code>app_heartbeat_start()</code> is called.</p>
</div>
<div id="rd_status_t-app_heartbeat_startuint16_t-heartbeat_ms" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.1.3</span> <code>rd_status_t app_heartbeat_start(uint16_t heartbeat_ms)</code><a href="sensor.html#rd_status_t-app_heartbeat_startuint16_t-heartbeat_ms" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Start and store the heartbeat with the new interval.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>heartbeat_ms</td>
<td>in</td>
<td>New interval for heartbeat in milliseconds.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ruuvi_task_sensor.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.2</span> ruuvi_task_sensor.c<a href="sensor.html#ruuvi_task_sensor.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="rd_status_t-rt_sensor_get_from_fdbfdb_kvdb_t-kvdb-rt_sensor_ctx_t-sensor" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.1</span> <code>rd_status_t rt_sensor_get_from_fdb(fdb_kvdb_t kvdb, rt_sensor_ctx_t *sensor)</code><a href="sensor.html#rd_status_t-rt_sensor_get_from_fdbfdb_kvdb_t-kvdb-rt_sensor_ctx_t-sensor" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Retrieves data from fdb-kv-partition and loads it onto the sensor struct.
#### <code>rd_status_t rt_sensor_store_to_fdb(fdb_kvdb_t kvdb, rt_sensor_ctx_t *sensor)</code> ####</p>
<p>Stores data from the sensor-struct to the kvdb, referencing the current timestamp.
### app_accelerometer_logging.c ###</p>
</div>
<div id="rd_status_t-app_enable_sensor_loggingconst-bool-use_ram_db-const-bool-format_db" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.2</span> <code>rd_status_t app_enable_sensor_logging(const bool use_ram_db, const bool format_db)</code><a href="sensor.html#rd_status_t-app_enable_sensor_loggingconst-bool-use_ram_db-const-bool-format_db" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Enables the logging of acceleration data.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>use_ram_db</td>
<td>in</td>
<td>Database in RAM is used in case of streaming of acceleration data.</td>
</tr>
<tr class="even">
<td>format_db</td>
<td>in</td>
<td>This parameter is set to true if logging is enabled by gateway to ensure the database is cleared. When re-enabling logging after reboot it is set to false.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is already enabled.</td>
<td></td>
</tr>
<tr class="even">
<td>RD_ERROR_NOT_FOUND</td>
<td>If LIS2DH12 is not available.</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_disable_sensor_loggingvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.3</span> <code>rd_status_t app_disable_sensor_logging(void)</code><a href="sensor.html#rd_status_t-app_disable_sensor_loggingvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Disables the logging of acceleration data.</p>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is already disabled.</td>
</tr>
<tr class="even">
<td>RD_ERROR_NOT_FOUND</td>
<td>If LIS2DH12 is not available.</td>
</tr>
</tbody>
</table>
</div>
<div id="void-on_fifo_full-const-ri_gpio_evt_t-evt" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.4</span> <code>void on_fifo_full (const ri_gpio_evt_t evt)</code><a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Callback function when FIFO full interrupt occurs at LIS2DH12. If using streaming this function reads the FIFO and writes the values to RAMDB.</p>
<p>Without streaming it schedules the execution of <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>void fifo_full_handler (void * p_event_data, uint16_t event_size)</code></a> to read the FIFO outside interrupt context. See ruuvi_interface_scheduler.h for parameters used in this function.</p>
</div>
<div id="void-fifo_full_handler-void-p_event_data-uint16_t-event_size" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.5</span> <code>void fifo_full_handler (void * p_event_data, uint16_t event_size)</code><a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function reads the FIFO and stores the data inside the timeseries database. See ruuvi_interface_scheduler.h for parameters used in this function.</p>
</div>
<div id="void-packconst-uint8_t-resolution-const-uint16_t-sizedata-const-uint8_t-const-data-uint8_t-const-packeddata" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.6</span> <code>void pack(const uint8_t resolution, const uint16_t sizeData, const uint8_t* const data, uint8_t* const packeddata)</code><a href="sensor.html#void-packconst-uint8_t-resolution-const-uint16_t-sizedata-const-uint8_t-const-data-uint8_t-const-packeddata" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function stores raw accelerometer values in 8/10/12 Bit format in compact form (without unused bits). It is a frontend to the functions pack8/10/12().</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>resolution</td>
<td>in</td>
<td>Resolution of the samples.</td>
</tr>
<tr class="even">
<td>sizeData</td>
<td>in</td>
<td>Size of input data.</td>
</tr>
<tr class="odd">
<td>data</td>
<td>in</td>
<td>Input data.</td>
</tr>
<tr class="even">
<td>packeddata</td>
<td>in/out</td>
<td>Memory for storing compacted data.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.7</span> <code>rd_status_t lis2dh12_logged_data_get (rd_sensor_data_t * const data)</code><a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function retrieves raw accelerometer values from memory. The values are parsed and returned inside data. It is called by <code>app_sensor_get()</code> inside <a href="sensor.html#app_sensor.c">app_sensor.c</a> if accelerometer logging is active.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>raw_data</td>
<td>in/out</td>
<td>Memory for storing accelerometer values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_send_eof_v2const-ri_comm_xfer_fp_t-reply_fp-const-rd_status_t-status_code-const-uint16_t-crc" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.8</span> <code>rd_status_t app_acc_logging_send_eof_v2(const ri_comm_xfer_fp_t reply_fp, const rd_status_t status_code, const uint16_t crc)</code><a href="sensor.html#rd_status_t-app_acc_logging_send_eof_v2const-ri_comm_xfer_fp_t-reply_fp-const-rd_status_t-status_code-const-uint16_t-crc" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function is called by <a href="sensor.html#rd_status_t-app_acc_logging_send_logged_dataconst-ri_comm_xfer_fp_t-reply_fp-const-bool-is_v2"><code>app_acc_logging_send_logged_data()</code></a> after all data is sent to the requestor. This function builds the <a href="ble-gatt-messages.html#end-of-data-message">end of data message</a> and sends it.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>reply_fp</td>
<td>in</td>
<td>Function pointer to reply function.</td>
</tr>
<tr class="even">
<td>status_code</td>
<td>in</td>
<td>Status code of the whole operation. This code is sent to the requestor.</td>
</tr>
<tr class="odd">
<td>crc</td>
<td>in</td>
<td>CRC value of the data.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_send_logged_dataconst-ri_comm_xfer_fp_t-reply_fp" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.9</span> <code>rd_status_t app_acc_logging_send_logged_data(const ri_comm_xfer_fp_t reply_fp)</code><a href="sensor.html#rd_status_t-app_acc_logging_send_logged_dataconst-ri_comm_xfer_fp_t-reply_fp" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function is called when a request to send the logged acceleration data is received by GATT/UART. The function triggers FlashDB to read data. Data from the database is read via the callback function <a href="sensor.html#bool-callback_send_data_blockfdb_tsl_t-tsl-void-arg"><code>callback_send_data_block()</code></a>. Inside the callback function the data is send to the requestor.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>reply_fp</td>
<td>in</td>
<td>Function pointer to reply function.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is not active.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_statevoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.10</span> <code>rd_status_t app_acc_logging_state(void)</code><a href="sensor.html#rd_status_t-app_acc_logging_statevoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function is used to query the state of accelerometer logging. It is called when a control message is received by GATT/UART to return this state to the caller. If streaming is active, this will not be reported as active logging by this function.</p>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_SUCCESS</td>
<td>If logging is active.</td>
</tr>
<tr class="even">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is not active.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_configuration_set-rt_sensor_ctx_t-sensor-rd_sensor_configuration_t-new_config" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.11</span> <code>rd_status_t app_acc_logging_configuration_set (rt_sensor_ctx_t* sensor, rd_sensor_configuration_t* new_config)</code><a href="sensor.html#rd_status_t-app_acc_logging_configuration_set-rt_sensor_ctx_t-sensor-rd_sensor_configuration_t-new_config" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function is called when a request to update the sensor configuration is received by GATT/UART. It checks every configuration parameter if it should be changed. It also checks if the value is different than actual value. If a change is detected it clears the ringbuffer, updates the configuration and stores the configuration in flash.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sensor</td>
<td>in</td>
<td>Sensor context of the sensor which configuration should be changed.</td>
</tr>
<tr class="even">
<td>new_config</td>
<td>in</td>
<td>Structure containing the new configuration values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_initvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.12</span> <code>rd_status_t app_acc_logging_init(void)</code><a href="sensor.html#rd_status_t-app_acc_logging_initvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Initialize acceleration logging during boot. If logging was active before reboot it will be activated. If logging was not active before reboot this function return <code>RD_SUCCESS</code> without activating acceleration logging.</p>
<p>This function is called from <a href="sensor.html#void-setup-void"><code>setup()</code></a>.</p>
</div>
<div id="rd_status_t-app_acc_logging_uninitvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.13</span> <code>rd_status_t app_acc_logging_uninit(void)</code><a href="sensor.html#rd_status_t-app_acc_logging_uninitvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The uninitialization of acceleration logging disables the logging if it is actually active. If logging is not active this function return RD_SUCCESS without doing anything.</p>
</div>
<div id="void-app_acc_log_transfer_ram_db-void-p_event_data-uint16_t-event_size" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.14</span> <code>void app_acc_log_transfer_ram_db (void * p_event_data, uint16_t event_size)</code><a href="sensor.html#void-app_acc_log_transfer_ram_db-void-p_event_data-uint16_t-event_size" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Execution of this function is scheduled if “streaming” is active and <code>rt_gatt_nus_is_connected()</code> returns true. It starts reading currently logged data from the FlashDB and transferring the data to the gateway.</p>
<p>Scheduling of this function is done inside <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a> using <code>ri_scheduler_event_put()</code>.</p>
</div>
<div id="int64_t-fdb_timestamp_get-void" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.15</span> <code>int64_t fdb_timestamp_get (void)</code><a href="sensor.html#int64_t-fdb_timestamp_get-void" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Callback for use by FlashDB to retrieve the timestamp of the current new entry.</p>
</div>
<div id="bool-callback_send_data_blockfdb_tsl_t-tsl-void-arg" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.16</span> <code>bool callback_send_data_block(fdb_tsl_t tsl, void *arg)</code><a href="sensor.html#bool-callback_send_data_blockfdb_tsl_t-tsl-void-arg" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Callback function for use with FlashDB. When reading the database this function will be called for every entry.</p>
<p>This function calls <code>app_comms_blocking_send()</code> to send the data to the gateway.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>tsl</td>
<td>in</td>
<td>Pointer to current entry in the database.</td>
</tr>
<tr class="even">
<td>arg</td>
<td>in/out</td>
<td>Pointer to context. See following table. The array consists of the following elements.</td>
</tr>
</tbody>
</table>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Context parameters by <code>*arg</code></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>((void**)arg)[0]</code></td>
<td>in</td>
<td>Pointer to database of type <code>fdb_tsdb*</code>.</td>
</tr>
<tr class="even">
<td><code>((void**)arg)[1]</code></td>
<td>in</td>
<td>Pointer to transfer function <code>app_comms_blocking_send()</code>.</td>
</tr>
<tr class="odd">
<td><code>((void**)arg)[2]</code></td>
<td>in/out</td>
<td>Pointer to CRC value.</td>
</tr>
</tbody>
</table>
<p>If this functions returns <code>true</code> iterating over the following entries will by aborted.</p>
</div>
<div id="rd_status_t-app_acc_logging_statistic-uint8_t-const-statistic" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.17</span> <code>rd_status_t app_acc_logging_statistic (uint8_t* const statistic)</code><a href="sensor.html#rd_status_t-app_acc_logging_statistic-uint8_t-const-statistic" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function is called from <code>handle_lis2dh12_comms()</code> after the gateway sends the message to retrieve flash statistics.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>statistic</td>
<td>in/out</td>
<td>Memory to store the statistic values.</td>
</tr>
</tbody>
</table>
</div>
<div id="uint8_t-ruuvi_error_code_to_uint8rd_status_t-err_code" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.2.18</span> <code>uint8_t ruuvi_error_code_to_uint8(rd_status_t err_code)</code><a href="sensor.html#uint8_t-ruuvi_error_code_to_uint8rd_status_t-err_code" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function converts an Ruuvi error code to a one byte value. It returns the bit index of first error it finds. It cannot return a set of multiple errors as the input value supports.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>err_code</td>
<td>in</td>
<td>Ruuvi error code.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="app_comms.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.3</span> app_comms.c<a href="sensor.html#app_comms.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="void-handle_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.3.1</span> <code>void handle_comms (const ri_comm_xfer_fp_t reply_fp, const uint8_t * const raw_message, size_t data_len)</code><a href="sensor.html#void-handle_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Added new switch/case which forwards messages regarding configuration and control of acceleration logging to the function <a href="sensor.html#rd_status_t-handle_lis2dh12_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_lis2dh12_comms()</code></a>, <a href="sensor.html#rd_status_t-handle_lis2dh12_comms_v2-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_lis2dh12_comms_v2()</code></a>, <a href="sensor.html#rd_status_t-handle_rtc_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_rtc_comms()</code></a>.</p>
</div>
<div id="rd_status_t-handle_lis2dh12_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.3.2</span> <code>rd_status_t handle_lis2dh12_comms (const ri_comm_xfer_fp_t reply_fp, const uint8_t * const raw_message, size_t data_len)</code><a href="sensor.html#rd_status_t-handle_lis2dh12_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function handles messages using the proprietary message format by GATT/UART communication needed to control the functionality of acceleration logging.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>reply_fp</td>
<td>in</td>
<td>Function pointer to reply function.</td>
</tr>
<tr class="even">
<td>raw_message</td>
<td>in</td>
<td>Message received.</td>
</tr>
<tr class="odd">
<td>data_len</td>
<td>in</td>
<td>Length of the received message.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_NOT_FOUND</td>
<td>If LIS2DH12 is not found.</td>
</tr>
<tr class="even">
<td>RD_ERROR_INVALID_PARAM</td>
<td>If unknown or invalid message was received.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-handle_lis2dh12_comms_v2-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.3.3</span> <code>rd_status_t handle_lis2dh12_comms_v2 (const ri_comm_xfer_fp_t reply_fp, const uint8_t * const raw_message, size_t data_len)</code><a href="sensor.html#rd_status_t-handle_lis2dh12_comms_v2-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function handles messages using version 2 message format by GATT/UART communication needed to control the functionality of acceleration logging.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>reply_fp</td>
<td>in</td>
<td>Function pointer to reply function.</td>
</tr>
<tr class="even">
<td>raw_message</td>
<td>in</td>
<td>Message received.</td>
</tr>
<tr class="odd">
<td>data_len</td>
<td>in</td>
<td>Length of the received message.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_NOT_FOUND</td>
<td>If LIS2DH12 is not found.</td>
</tr>
<tr class="even">
<td>RD_ERROR_INVALID_PARAM</td>
<td>If unknown or invalid message was received.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-handle_rtc_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.3.4</span> <code>rd_status_t handle_rtc_comms (const ri_comm_xfer_fp_t reply_fp, const uint8_t * const raw_message, size_t data_len)</code><a href="sensor.html#rd_status_t-handle_rtc_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function handles messages using version 2 message format by GATT/UART communication needed to control the RTC clock.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>reply_fp</td>
<td>in</td>
<td>Function pointer to reply function.</td>
</tr>
<tr class="even">
<td>raw_message</td>
<td>in</td>
<td>Message received.</td>
</tr>
<tr class="odd">
<td>data_len</td>
<td>in</td>
<td>Length of the received message.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_INVALID_PARAM</td>
<td>If unknown or invalid message was received.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-dis_init-ri_comm_dis_init_t-const-p_dis-const-bool-secure" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.3.5</span> <code>rd_status_t dis_init (ri_comm_dis_init_t * const p_dis, const bool secure)</code><a href="sensor.html#rd_status_t-dis_init-ri_comm_dis_init_t-const-p_dis-const-bool-secure" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function is called during initialization of the Bluetooth protocol stack.</p>
<p>Our extension to this function is executed if <code>app_sensor_ctx_get()</code> from app_sensors.c is available. It sets the hardware revision string inside <code>ri_comm_dis_init_t</code> to the list of available and initialized sensors.</p>
</div>
</div>
<div id="ruuvi_nrf5_sdk15_communication_ble_gatt.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.4</span> ruuvi_nrf5_sdk15_communication_ble_gatt.c<a href="sensor.html#ruuvi_nrf5_sdk15_communication_ble_gatt.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="rd_status_t-ri_gatt_dis_init-const-ri_comm_dis_init_t-const-p_dis" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.4.1</span> <code>rd_status_t ri_gatt_dis_init (const ri_comm_dis_init_t * const p_dis)</code><a href="sensor.html#rd_status_t-ri_gatt_dis_init-const-ri_comm_dis_init_t-const-p_dis" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function is called during initialization of the Bluetooth protocol stack. Our extension to this function adds a buildnumber to the former unused property <code>sw_rev_str</code> of <code>ble_dis_init_t</code>. The buildnumber is generated by a pre-build script <code>buildnum.js</code> which is executed by Segger Embedded Studio before compiling the software. The pre-buold script generated <code>buildnum.h</code> which includes the buildnumber.</p>
</div>
</div>
<div id="app_config.h" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.5</span> app_config.h<a href="sensor.html#app_config.h" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>Added macro APP_SENSOR_LOGGING to control compilation of app_accelerometer_logging.*</li>
<li>If APP_SENSOR_LOGGING is not defined or is defined as 0 the functionality of logging of acceleration data is not available in the application.</li>
<li>Changed the definition of APP_FLASH_PAGES to include the flash pages used for acceleration logging.</li>
<li>This module also contains macros for memory separation between acceleration logging and environmental logging. The relevant macros are APP_FLASH_LOG_DATA_RECORDS_NUM and RT_FLASH_RINGBUFFER_MAXSIZE.</li>
</ul>
</div>
<div id="app_sensor.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.6</span> app_sensor.c<a href="sensor.html#app_sensor.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="rt_sensor_ctx_t-app_sensor_find-const-char-name" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.6.1</span> <code>rt_sensor_ctx_t* app_sensor_find (const char *name)</code><a href="sensor.html#rt_sensor_ctx_t-app_sensor_find-const-char-name" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Find sensor by its name. Works only with initialized sensors, will not return a sensor which is supported in firmware but not initialized.</p>
<p>This function is called by <a href="sensor.html#rd_status_t-app_enable_sensor_loggingvoid"><code>app_enable_sensor_logging()</code></a> and <a href="sensor.html#rd_status_t-app_disable_sensor_loggingvoid"><code>app_disable_sensor_logging()</code></a> to retrieve the sensor context.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>in</td>
<td>Name of the sensor.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="main.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.7</span> main.c<a href="sensor.html#main.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="void-setup-void" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.7.1</span> <code>void setup (void)</code><a href="sensor.html#void-setup-void" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Added call to <a href="sensor.html#rd_status_t-app_acc_logging_initvoid"><code>app_acc_logging_init()</code></a> to initialize acceleration logging.</p>
</div>
</div>
<div id="ruuvi_interface_lis2dh12.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.8</span> ruuvi_interface_lis2dh12.c<a href="sensor.html#ruuvi_interface_lis2dh12.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="rd_status_t-ri_lis2dh12_acceleration_raw_get-uint8_t-const-raw_data" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.8.1</span> <code>rd_status_t ri_lis2dh12_acceleration_raw_get (uint8_t * const raw_data)</code><a href="sensor.html#rd_status_t-ri_lis2dh12_acceleration_raw_get-uint8_t-const-raw_data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function reads raw acceleration values from the registers of LIS2DH12. It is called from the <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size">interrupt handler</a> inside <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a> and from <a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data"><code>ri_lis2dh12_data_get()</code></a>.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>raw_data</td>
<td>in/out</td>
<td>Memory for storing raw accelerometer values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-ri_lis2dh12_temperature_raw_get-uint8_t-const-raw_temperature" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.8.2</span> <code>rd_status_t ri_lis2dh12_temperature_raw_get (uint8_t * const raw_temperature)</code><a href="sensor.html#rd_status_t-ri_lis2dh12_temperature_raw_get-uint8_t-const-raw_temperature" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function reads raw temperature value from the registers of LIS2DH12. It is called <a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data"><code>ri_lis2dh12_data_get()</code></a> and <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>raw_temperature</td>
<td>in/out</td>
<td>Memory for storing raw temperature values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.8.3</span> <code>rd_status_t ri_lis2dh12_data_get (rd_sensor_data_t * const data)</code><a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The original function <code>ri_lis2dh12_data_get()</code> is split into retrieving raw values from the sensor and parsing these data. Parsing is done by <a href="sensor.html#rd_status_t-ri_lis2dh12_raw_data_parse-rd_sensor_data_t-const-data-axis3bit16_t-raw_acceleration-uint8_t-raw_temperature"><code>ri_lis2dh12_raw_data_parse()</code></a>.</p>
<p>This function is used if the acceleration logging is not active. If acceleration logging is active this function is replaced by <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>data</td>
<td>in/out</td>
<td>Structure for storing parsed accelerometer values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-ri_lis2dh12_raw_data_parse-rd_sensor_data_t-const-data-axis3bit16_t-raw_acceleration-uint8_t-raw_temperature" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.8.4</span> <code>rd_status_t ri_lis2dh12_raw_data_parse (rd_sensor_data_t * const data, axis3bit16_t *raw_acceleration, uint8_t *raw_temperature)</code><a href="sensor.html#rd_status_t-ri_lis2dh12_raw_data_parse-rd_sensor_data_t-const-data-axis3bit16_t-raw_acceleration-uint8_t-raw_temperature" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function parses raw values from the sensor and stores the values inside data. It is called from <a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data"><code>ri_lis2dh12_data_get()</code></a> and from <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>data</td>
<td>in/out</td>
<td>Structure for storing parsed accelerometer values.</td>
</tr>
<tr class="even">
<td>raw_acceleration</td>
<td>in</td>
<td>Raw acceleration values.</td>
</tr>
<tr class="odd">
<td>raw_temperature</td>
<td>in</td>
<td>Raw temperature value. This parameter can be NULL.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ruuvi_nrf5_sdk_rtc_mcu.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.9</span> ruuvi_nrf5_sdk_rtc_mcu.c<a href="sensor.html#ruuvi_nrf5_sdk_rtc_mcu.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="rd_status_t-ri_set_rtc_millisuint64_t-millis" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.9.1</span> <code>rd_status_t ri_set_rtc_millis(uint64_t millis)</code><a href="sensor.html#rd_status_t-ri_set_rtc_millisuint64_t-millis" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Set system time by external source. Set RTC to zero.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>millis</td>
<td>in</td>
<td>External time.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ruuvi_nrf5_sdk15_power.c-ruuvi_nrf5_sdk15_power.h" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.10</span> ruuvi_nrf5_sdk15_power.c / ruuvi_nrf5_sdk15_power.h<a href="sensor.html#ruuvi_nrf5_sdk15_power.c-ruuvi_nrf5_sdk15_power.h" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="rd_status_t-ri_power_read_boot_count-uint32_t-boot_count" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.10.1</span> <code>rd_status_t ri_power_read_boot_count (uint32_t *boot_count)</code><a href="sensor.html#rd_status_t-ri_power_read_boot_count-uint32_t-boot_count" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function return the boot counter.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>boot_count</td>
<td>out</td>
<td>Memory for storing the boot counter.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ruuvi_task_flash_ringbuffer.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.11</span> ruuvi_task_flash_ringbuffer.c<a href="sensor.html#ruuvi_task_flash_ringbuffer.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The ringbuffer module acts as a frontend to FlashDB. The ringbuffer functionality is provided by the timeseries database of FlashDB.</p>
<div id="rd_status_t-rt_flash_ringbuffer_createconst-char-partition-fdb_get_time-get_time-const-bool-format_db" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.11.1</span> <code>rd_status_t rt_flash_ringbuffer_create(const char *partition, fdb_get_time get_time, const bool format_db)</code><a href="sensor.html#rd_status_t-rt_flash_ringbuffer_createconst-char-partition-fdb_get_time-get_time-const-bool-format_db" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function initializes an instance of timeseries database.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>partition</td>
<td>in</td>
<td>Name of the partition of the FAL device where the database will be stored.</td>
</tr>
<tr class="even">
<td>get_time</td>
<td>in</td>
<td>Function pointer to callback function. This function is used by timeseries database to retrieve the current timestamp.</td>
</tr>
<tr class="odd">
<td>format_db</td>
<td>in</td>
<td>Wether to force to create a empty database.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_writeconst-uint16_t-size-const-void-data" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.11.2</span> <code>rd_status_t rt_flash_ringbuffer_write(const uint16_t size, const void* data)</code><a href="sensor.html#rd_status_t-rt_flash_ringbuffer_writeconst-uint16_t-size-const-void-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function writes data to FlashDB.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>size</td>
<td>in</td>
<td>Size of data</td>
</tr>
<tr class="even">
<td>data</td>
<td>in</td>
<td>Data to be written</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_readconst-fdb_tsl_cb-callback-const-ri_comm_xfer_fp_t-reply_fp-uint16_t-crc" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.11.3</span> <code>rd_status_t rt_flash_ringbuffer_read(const fdb_tsl_cb callback, const ri_comm_xfer_fp_t reply_fp, uint16_t* crc)</code><a href="sensor.html#rd_status_t-rt_flash_ringbuffer_readconst-fdb_tsl_cb-callback-const-ri_comm_xfer_fp_t-reply_fp-uint16_t-crc" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function starts reading the timeseries database. Reading data from timeseries database is done by iterating all entries. For every entry a callback function is called.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>callback</td>
<td>in</td>
<td>Callback function which would be called for every entry.</td>
</tr>
<tr class="even">
<td>reply_fp</td>
<td>in</td>
<td>Callback function which sends the data to the requestor.</td>
</tr>
<tr class="odd">
<td>crc</td>
<td>in/out</td>
<td>CRC16 value which gets calculated over all data send to the requestor.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_clearvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.11.4</span> <code>rd_status_t rt_flash_ringbuffer_clear(void)</code><a href="sensor.html#rd_status_t-rt_flash_ringbuffer_clearvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function clears the contents of the timeseries database.</p>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_drop-void" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.11.5</span> <code>rd_status_t rt_flash_ringbuffer_drop (void)</code><a href="sensor.html#rd_status_t-rt_flash_ringbuffer_drop-void" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function de-initializes the timeseries database.</p>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_statistic-uint8_t-const-statistic" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.11.6</span> <code>rd_status_t rt_flash_ringbuffer_statistic (uint8_t* const statistic)</code><a href="sensor.html#rd_status_t-rt_flash_ringbuffer_statistic-uint8_t-const-statistic" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function reads some statistics about the usage of the internal Nordic Flash memory and returns them.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>statistic</td>
<td>in/out</td>
<td>Memory for storing statistics.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ruuvi_task_flashdb.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.12</span> ruuvi_task_flashdb.c<a href="sensor.html#ruuvi_task_flashdb.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This module contains supporting functions needed to integrate FlashDB into Ruuvi Firmware.</p>
<div id="rd_status_t-rt_macronix_flash_existsvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.12.1</span> <code>rd_status_t rt_macronix_flash_exists(void)</code><a href="sensor.html#rd_status_t-rt_macronix_flash_existsvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function checks if Macronix Flash Chip is available.</p>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_SUCCESS</td>
<td>If Macronix Flash is available.</td>
</tr>
<tr class="even">
<td>RD_ERROR_NOT_FOUND</td>
<td>If Macronix Flash is not available.</td>
</tr>
<tr class="odd">
<td>RD_ERROR_NOT_INITIALIZED</td>
<td>If the module is currently not initialzed.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flashdb_to_ruuvi_errorfdb_err_t-fdb_err" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.12.2</span> <code>rd_status_t rt_flashdb_to_ruuvi_error(fdb_err_t fdb_err)</code><a href="sensor.html#rd_status_t-rt_flashdb_to_ruuvi_errorfdb_err_t-fdb_err" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function converts an error code of FlashDB to an Ruuvi error code. It return the Ruuvi error code which represents the state of FlashDB.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fdb_err</td>
<td>in</td>
<td>Error code of FlashDB.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_reset_macronix_flashvoid" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.12.3</span> <code>rd_status_t rt_reset_macronix_flash(void)</code><a href="sensor.html#rd_status_t-rt_reset_macronix_flashvoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This functions sends the Chip Erase command to the macronix flash chip if the chip is available. This function is called during factory reset.</p>
</div>
<div id="rt_macronix_high_performance_switchconst-bool-enable" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.12.4</span> <code>rt_macronix_high_performance_switch(const bool enable)</code><a href="sensor.html#rt_macronix_high_performance_switchconst-bool-enable" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function configures the high performance switch of the Macronix Flash Chip. High performance mode is used during formating the flash in order to prepare it for the database or during factory reset.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>enable</td>
<td>in</td>
<td>Desired mode of operation.</td>
</tr>
</tbody>
</table>
</div>
<div id="void-fdb_log-const-char-const-msg-..." class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.12.5</span> <code>void fdb_log (const char * const msg, ...)</code><a href="sensor.html#void-fdb_log-const-char-const-msg-..." class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function acts as a proxy between the logging mechanism of FlashDB and the log writing system of Ruvvi. It converts the parameters and passes log messages to Ruuvi’s logging module.</p>
</div>
</div>
<div id="app_button.c" class="section level3 hasAnchor">
<h3><span class="header-section-number">6.8.13</span> app_button.c<a href="sensor.html#app_button.c" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="void-factory_reset-void-p_event_data-uint16_t-event_size" class="section level4 hasAnchor">
<h4><span class="header-section-number">6.8.13.1</span> <code>void factory_reset (void * p_event_data, uint16_t event_size)</code><a href="sensor.html#void-factory_reset-void-p_event_data-uint16_t-event_size" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Add call to <a href="sensor.html#rd_status_t-rt_reset_macronix_flashvoid"><code>rt_reset_macronix_flash()</code></a> to delete content of Macronix Flash in case of factory reset.</p>
</div>
</div>
</div>
<div id="energy-consumption" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.9</span> Energy consumption<a href="sensor.html#energy-consumption" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The following figure visualizes energy consumption of different operation states. The numbers at the measuring point are equal to the duration. All measurements are done with 3V supply voltage.</p>
<p><img src="bchwtz-bdcs_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
</div>
<div id="firmware-packaging" class="section level2 hasAnchor">
<h2><span class="header-section-number">6.10</span> Firmware packaging<a href="sensor.html#firmware-packaging" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To create a File which is suitable for <a href="https://ruuvi.com/software-update/">DFU</a> you need <a href="https://www.nordicsemi.com/Products/Development-tools/nRF-Util">nrfutil</a> from Nordic Semiconductor. The DFU Package must be signed. The <a href="https://github.com/ruuvi/ruuvi.nrf5_sdk15_bootloader.c/blob/master/ruuvi_open_private.pem">private key</a> can be obtained from Ruuvi’s Github repository.</p>
<p>The following script to create a DFU package assumes this directory structure.</p>
<pre><code>dfu-package
 \
  | ruuvi_open_private.pem
ruuvi.firmware.c
 \
  | nRF5_SDK_15.3.0_59ac345
  | src
  | \
  |  | output
  |  | \
  |  |  | debug
  |  |  | \
  |  |  |  | exe</code></pre>
<p>To create a DFU package execute the following commands inside directory dfu-package.</p>
<pre><code>nrfutil settings generate --family NRF52 --application ..\ruuvi.firmware.c\src\Output\Debug\Exe\ruuvitag_b.hex --application-version 1  --bootloader-version 1 --bl-settings-version 1 output\settings.hex
mergehex -m ..\ruuvi.firmware.c\nRF5_SDK_15.3.0_59ac345\components\softdevice\s132\hex\s132_nrf52_6.1.1_softdevice.hex ruuvitag_b_s132_6.1.1_bootloader_3.1.0.hex output\settings.hex -o output\sbc.hex
mergehex -m output\sbc.hex ..\ruuvi.firmware.c\src\Output\Debug\Exe\ruuvitag_b.hex -o output\packet.hex
nrfutil pkg generate --application ..\ruuvi.firmware.c\src\Output\Debug\Exe\ruuvitag_b.hex --application-version 1 --hw-version 0xB0 --sd-req 0xB7 --key-file ruuvi_open_private.pem dfu_app.zip</code></pre>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="getting-started-package.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="external-flash-integration.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/11-docs-sensor.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bchwtz-bdcs.pdf", "bchwtz-bdcs.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
