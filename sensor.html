<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Sensor | Big Data Case Studies</title>
  <meta name="description" content="Chapter 3 Sensor | Big Data Case Studies" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Sensor | Big Data Case Studies" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Chapter 3 Sensor | Big Data Case Studies" />
  <meta name="github-repo" content="bchwtz/bchwtz-bdcs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Sensor | Big Data Case Studies" />
  
  <meta name="twitter:description" content="Chapter 3 Sensor | Big Data Case Studies" />
  

<meta name="author" content="Benjamin Buchwitz" />


<meta name="date" content="2021-05-15" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="getting-started.html"/>
<link rel="next" href="gateway.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><b>Big Data Case Studies</b></a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>2</b> Getting Started</a><ul>
<li class="chapter" data-level="2.1" data-path="getting-started.html"><a href="getting-started.html#sensor-development-environment"><i class="fa fa-check"></i><b>2.1</b> Sensor Development Environment</a><ul>
<li class="chapter" data-level="2.1.1" data-path="getting-started.html"><a href="getting-started.html#software-setup"><i class="fa fa-check"></i><b>2.1.1</b> Software Setup</a></li>
<li class="chapter" data-level="2.1.2" data-path="getting-started.html"><a href="getting-started.html#hardware-setup"><i class="fa fa-check"></i><b>2.1.2</b> Hardware Setup</a></li>
<li class="chapter" data-level="2.1.3" data-path="getting-started.html"><a href="getting-started.html#testing-the-gateway-connection"><i class="fa fa-check"></i><b>2.1.3</b> Testing the Gateway Connection</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="getting-started.html"><a href="getting-started.html#gateway-development-environment"><i class="fa fa-check"></i><b>2.2</b> Gateway Development Environment</a></li>
</ul></li>
<li class="part"><span><b>Documentation</b></span></li>
<li class="chapter" data-level="3" data-path="sensor.html"><a href="sensor.html"><i class="fa fa-check"></i><b>3</b> Sensor</a><ul>
<li class="chapter" data-level="3.1" data-path="sensor.html"><a href="sensor.html#initializing-acceleration-logging"><i class="fa fa-check"></i><b>3.1</b> Initializing acceleration logging</a></li>
<li class="chapter" data-level="3.2" data-path="sensor.html"><a href="sensor.html#retrieving-data-from-fifo"><i class="fa fa-check"></i><b>3.2</b> Retrieving data from FIFO</a></li>
<li class="chapter" data-level="3.3" data-path="sensor.html"><a href="sensor.html#using-the-data-by-hearbeat"><i class="fa fa-check"></i><b>3.3</b> Using the data by hearbeat</a></li>
<li class="chapter" data-level="3.4" data-path="sensor.html"><a href="sensor.html#initialization-during-boot"><i class="fa fa-check"></i><b>3.4</b> Initialization during boot</a></li>
<li class="chapter" data-level="3.5" data-path="sensor.html"><a href="sensor.html#implementation"><i class="fa fa-check"></i><b>3.5</b> Implementation</a><ul>
<li class="chapter" data-level="3.5.1" data-path="sensor.html"><a href="sensor.html#app_accelerometer_logging.c"><i class="fa fa-check"></i><b>3.5.1</b> app_accelerometer_logging.c</a></li>
<li class="chapter" data-level="3.5.2" data-path="sensor.html"><a href="sensor.html#app_comms.c"><i class="fa fa-check"></i><b>3.5.2</b> app_comms.c</a></li>
<li class="chapter" data-level="3.5.3" data-path="sensor.html"><a href="sensor.html#app_config.h"><i class="fa fa-check"></i><b>3.5.3</b> app_config.h</a></li>
<li class="chapter" data-level="3.5.4" data-path="sensor.html"><a href="sensor.html#app_heartbeat.c"><i class="fa fa-check"></i><b>3.5.4</b> app_heartbeat.c</a></li>
<li class="chapter" data-level="3.5.5" data-path="sensor.html"><a href="sensor.html#app_sensor.c"><i class="fa fa-check"></i><b>3.5.5</b> app_sensor.c</a></li>
<li class="chapter" data-level="3.5.6" data-path="sensor.html"><a href="sensor.html#main.c"><i class="fa fa-check"></i><b>3.5.6</b> main.c</a></li>
<li class="chapter" data-level="3.5.7" data-path="sensor.html"><a href="sensor.html#ruuvi_interface_lis2dh12.c"><i class="fa fa-check"></i><b>3.5.7</b> ruuvi_interface_lis2dh12.c</a></li>
<li class="chapter" data-level="3.5.8" data-path="sensor.html"><a href="sensor.html#ruuvi_nrf5_sdk_rtc_mcu.c"><i class="fa fa-check"></i><b>3.5.8</b> ruuvi_nrf5_sdk_rtc_mcu.c</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="sensor.html"><a href="sensor.html#ringbuffer-module"><i class="fa fa-check"></i><b>3.6</b> Ringbuffer module</a><ul>
<li class="chapter" data-level="3.6.1" data-path="sensor.html"><a href="sensor.html#general-functionality"><i class="fa fa-check"></i><b>3.6.1</b> General functionality</a></li>
<li class="chapter" data-level="3.6.2" data-path="sensor.html"><a href="sensor.html#project-related-use-case"><i class="fa fa-check"></i><b>3.6.2</b> Project-related use case</a></li>
<li class="chapter" data-level="3.6.3" data-path="sensor.html"><a href="sensor.html#implemented-functions"><i class="fa fa-check"></i><b>3.6.3</b> Implemented functions</a></li>
<li class="chapter" data-level="3.6.4" data-path="sensor.html"><a href="sensor.html#exemplary-use"><i class="fa fa-check"></i><b>3.6.4</b> Exemplary use</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gateway.html"><a href="gateway.html"><i class="fa fa-check"></i><b>4</b> Gateway</a><ul>
<li class="chapter" data-level="4.1" data-path="gateway.html"><a href="gateway.html#sensor-gateway-communication-library"><i class="fa fa-check"></i><b>4.1</b> Sensor Gateway Communication Library</a><ul>
<li class="chapter" data-level="4.1.1" data-path="gateway.html"><a href="gateway.html#activate-acceleration-logging"><i class="fa fa-check"></i><b>4.1.1</b> Activate acceleration logging</a></li>
<li class="chapter" data-level="4.1.2" data-path="gateway.html"><a href="gateway.html#deactivate-acceleration-logging"><i class="fa fa-check"></i><b>4.1.2</b> Deactivate acceleration logging</a></li>
<li class="chapter" data-level="4.1.3" data-path="gateway.html"><a href="gateway.html#set-sensor-configuration"><i class="fa fa-check"></i><b>4.1.3</b> Set sensor configuration</a></li>
<li class="chapter" data-level="4.1.4" data-path="gateway.html"><a href="gateway.html#set-sensor-time"><i class="fa fa-check"></i><b>4.1.4</b> Set sensor time</a></li>
<li class="chapter" data-level="4.1.5" data-path="gateway.html"><a href="gateway.html#get-sensor-configuratin"><i class="fa fa-check"></i><b>4.1.5</b> Get sensor configuratin</a></li>
<li class="chapter" data-level="4.1.6" data-path="gateway.html"><a href="gateway.html#get-sensor-time"><i class="fa fa-check"></i><b>4.1.6</b> Get sensor time</a></li>
<li class="chapter" data-level="4.1.7" data-path="gateway.html"><a href="gateway.html#get-last-sample"><i class="fa fa-check"></i><b>4.1.7</b> Get last sample</a></li>
<li class="chapter" data-level="4.1.8" data-path="gateway.html"><a href="gateway.html#get-acceleration-data"><i class="fa fa-check"></i><b>4.1.8</b> Get acceleration data</a></li>
<li class="chapter" data-level="4.1.9" data-path="gateway.html"><a href="gateway.html#find-macs"><i class="fa fa-check"></i><b>4.1.9</b> Find Macs</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="gateway.html"><a href="gateway.html#advertisement-logging"><i class="fa fa-check"></i><b>4.2</b> Advertisement logging</a></li>
<li class="chapter" data-level="4.3" data-path="gateway.html"><a href="gateway.html#data-storage-format"><i class="fa fa-check"></i><b>4.3</b> Data storage format</a><ul>
<li class="chapter" data-level="4.3.1" data-path="gateway.html"><a href="gateway.html#csv-file-acceleration-logging"><i class="fa fa-check"></i><b>4.3.1</b> Csv file acceleration Logging</a></li>
<li class="chapter" data-level="4.3.2" data-path="gateway.html"><a href="gateway.html#csv-file-advertisement-logging"><i class="fa fa-check"></i><b>4.3.2</b> Csv file advertisement Logging</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="backend.html"><a href="backend.html"><i class="fa fa-check"></i><b>5</b> Backend</a></li>
<li class="chapter" data-level="6" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html"><i class="fa fa-check"></i><b>6</b> BLE GATT Messages</a><ul>
<li class="chapter" data-level="6.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#control-messages"><i class="fa fa-check"></i><b>6.1</b> Control messages</a><ul>
<li class="chapter" data-level="6.1.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#start-transmitting-last-sample-0x03"><i class="fa fa-check"></i><b>6.1.1</b> Start transmitting last sample (<code>0x03</code>)</a></li>
<li class="chapter" data-level="6.1.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#start-transmitting-logged-data-0x05"><i class="fa fa-check"></i><b>6.1.2</b> Start transmitting logged data (<code>0x05</code>)</a></li>
<li class="chapter" data-level="6.1.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#set-configuration-of-acceleration-sensor-0x06"><i class="fa fa-check"></i><b>6.1.3</b> Set configuration of acceleration sensor (<code>0x06</code>)</a></li>
<li class="chapter" data-level="6.1.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#read-configuration-of-acceleration-sensor-0x07"><i class="fa fa-check"></i><b>6.1.4</b> Read configuration of acceleration sensor (<code>0x07</code>)</a></li>
<li class="chapter" data-level="6.1.5" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#set-system-time-0x08"><i class="fa fa-check"></i><b>6.1.5</b> Set system time (<code>0x08</code>)</a></li>
<li class="chapter" data-level="6.1.6" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#read-system-time-0x09"><i class="fa fa-check"></i><b>6.1.6</b> Read system time (<code>0x09</code>)</a></li>
<li class="chapter" data-level="6.1.7" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#control-acceleration-logging-0x0a"><i class="fa fa-check"></i><b>6.1.7</b> Control acceleration logging (<code>0x0A</code>)</a></li>
<li class="chapter" data-level="6.1.8" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#query-status-of-acceleration-logging-0x0b"><i class="fa fa-check"></i><b>6.1.8</b> Query status of acceleration logging (<code>0x0B</code>)</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#response-messages"><i class="fa fa-check"></i><b>6.2</b> Response messages</a><ul>
<li class="chapter" data-level="6.2.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#status-response-0x00"><i class="fa fa-check"></i><b>6.2.1</b> Status response (<code>0x00</code>)</a></li>
<li class="chapter" data-level="6.2.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#end-of-data-message-0x03-0x05"><i class="fa fa-check"></i><b>6.2.2</b> End of data message (<code>0x03</code>, <code>0x05</code>)</a></li>
<li class="chapter" data-level="6.2.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#configuration-response-0x07"><i class="fa fa-check"></i><b>6.2.3</b> Configuration response (<code>0x07</code>)</a></li>
<li class="chapter" data-level="6.2.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#timestamp-response-0x09"><i class="fa fa-check"></i><b>6.2.4</b> Timestamp response (<code>0x09</code>)</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#data-message"><i class="fa fa-check"></i><b>6.3</b> Data message</a><ul>
<li class="chapter" data-level="6.3.1" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format"><i class="fa fa-check"></i><b>6.3.1</b> 12 bit data format</a></li>
<li class="chapter" data-level="6.3.2" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format-1"><i class="fa fa-check"></i><b>6.3.2</b> 10 bit data format</a></li>
<li class="chapter" data-level="6.3.3" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#bit-data-format-2"><i class="fa fa-check"></i><b>6.3.3</b> 8 bit data format</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="ble-gatt-messages.html"><a href="ble-gatt-messages.html#communication-example"><i class="fa fa-check"></i><b>6.4</b> Communication example</a></li>
</ul></li>
<li class="part"><span><b>To Do</b></span></li>
<li class="chapter" data-level="7" data-path="sensor-1.html"><a href="sensor-1.html"><i class="fa fa-check"></i><b>7</b> Sensor</a><ul>
<li class="chapter" data-level="7.1" data-path="sensor-1.html"><a href="sensor-1.html#hardware"><i class="fa fa-check"></i><b>7.1</b> Hardware</a><ul>
<li class="chapter" data-level="7.1.1" data-path="sensor-1.html"><a href="sensor-1.html#external-flash-memory"><i class="fa fa-check"></i><b>7.1.1</b> External Flash Memory</a></li>
<li class="chapter" data-level="7.1.2" data-path="sensor-1.html"><a href="sensor-1.html#board-redesign"><i class="fa fa-check"></i><b>7.1.2</b> Board Redesign</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="sensor-1.html"><a href="sensor-1.html#software"><i class="fa fa-check"></i><b>7.2</b> Software</a><ul>
<li class="chapter" data-level="7.2.1" data-path="sensor-1.html"><a href="sensor-1.html#implementation-1"><i class="fa fa-check"></i><b>7.2.1</b> Implementation</a></li>
<li class="chapter" data-level="7.2.2" data-path="sensor-1.html"><a href="sensor-1.html#general-todo"><i class="fa fa-check"></i><b>7.2.2</b> General ToDo</a></li>
<li class="chapter" data-level="7.2.3" data-path="sensor-1.html"><a href="sensor-1.html#security"><i class="fa fa-check"></i><b>7.2.3</b> Security</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="gateway-1.html"><a href="gateway-1.html"><i class="fa fa-check"></i><b>8</b> Gateway</a><ul>
<li class="chapter" data-level="8.1" data-path="gateway-1.html"><a href="gateway-1.html#hardware-1"><i class="fa fa-check"></i><b>8.1</b> Hardware</a><ul>
<li class="chapter" data-level="8.1.1" data-path="gateway-1.html"><a href="gateway-1.html#uninterruptible-power-supply"><i class="fa fa-check"></i><b>8.1.1</b> Uninterruptible Power Supply</a></li>
<li class="chapter" data-level="8.1.2" data-path="gateway-1.html"><a href="gateway-1.html#camera"><i class="fa fa-check"></i><b>8.1.2</b> Camera</a></li>
<li class="chapter" data-level="8.1.3" data-path="gateway-1.html"><a href="gateway-1.html#g4g5g-module"><i class="fa fa-check"></i><b>8.1.3</b> 3g/4g/5g Module</a></li>
<li class="chapter" data-level="8.1.4" data-path="gateway-1.html"><a href="gateway-1.html#bluetooth-hardware"><i class="fa fa-check"></i><b>8.1.4</b> Bluetooth Hardware</a></li>
<li class="chapter" data-level="8.1.5" data-path="gateway-1.html"><a href="gateway-1.html#case"><i class="fa fa-check"></i><b>8.1.5</b> Case</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="gateway-1.html"><a href="gateway-1.html#software-1"><i class="fa fa-check"></i><b>8.2</b> Software</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="backend-1.html"><a href="backend-1.html"><i class="fa fa-check"></i><b>9</b> Backend</a></li>
<li class="part"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html"><i class="fa fa-check"></i>Contributors</a><ul>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html#ws-2020-2021"><i class="fa fa-check"></i>WS 2020 / 2021</a></li>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html#ss-2021"><i class="fa fa-check"></i>SS 2021</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="commerical-applications.html"><a href="commerical-applications.html"><i class="fa fa-check"></i>Commerical Applications</a><ul>
<li class="chapter" data-level="" data-path="commerical-applications.html"><a href="commerical-applications.html#literature"><i class="fa fa-check"></i>Literature</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="system-info.html"><a href="system-info.html"><i class="fa fa-check"></i>System Info</a></li>
<li class="divider"></li>
<li><a href="http://www.bchwtz.de" target="blank"><center>www.<b>BCHWTZ</b>.de</center></a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Big Data Case Studies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sensor" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Sensor</h1>
<p>The following figure shows the high level architecture of acceleration data logging in Ruuvi Tag. All configuration is done via the gateway. It communicates with the Ruuvi Tag using the Nordic UART interface via GATT messages transported by Bluetooth Low Energy (BLE). Most logic regarding acceleration logging is implemented inside the module <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a>.</p>
<p><img src="gfx/org/wrapping_of_data_get.png" /></p>
<p>Three use cases are shown in this figure.</p>
<div id="initializing-acceleration-logging" class="section level2">
<h2><span class="header-section-number">3.1</span> Initializing acceleration logging</h2>
<p>The initialization is shown with blue arrows and numbers in black circles until #4.</p>
<p>To activate acceleration logging the gateway sends the message <a href="ble-gatt-messages.html#control-acceleration-logging-0x0a"><code>0xFA 0xFA 0x0A 0x01</code></a>. In general GATT messages are handled by the function <a href="sensor.html#void-handle_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_comms()</code></a> inside the module <a href="sensor.html#app_comms.c">app_comm.c</a>. Messages regarding acceleration logging are delegated to the function <a href="sensor.html#rd_status_t-handle_lis2dh12_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_lis2dh12_comms()</code></a> inside the same module. After receiving the message to activate acceleration logging the function <a href="sensor.html#rd_status_t-app_enable_sensor_loggingvoid"><code>app_enable_sensor_logging()</code></a> inside the module <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a> in called (1).</p>
<p>The first step in activation is to check if some conditions are fulfilled. The function returns an error code if acceleration logging is already active or if it is called on a sensor which does not include an LIS2DH12. This check is done by calling <a href="sensor.html#rt_sensor_ctx_t-app_sensor_find-const-char-name"><code>find_sensor()</code></a> inside of <a href="sensor.html#app_sensor.c">app_sensor.c</a> (2). This function returns the sensor context. The sensor context consists of several information about the sensor. The next step associates the function <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a> from <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a> with the interrupt pin retrieved from the sensor context (3). The last step is to activate FIFO and interrupt generation inside the LIS2DH12. This is done by calling two functions from the sensor context. At last the function pointer to <code>data_get()</code> inside the sensor context is replaced by the pointer to the function <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
</div>
<div id="retrieving-data-from-fifo" class="section level2">
<h2><span class="header-section-number">3.2</span> Retrieving data from FIFO</h2>
<p>When FIFO is full inside LIS2DH12 the interrupt starts the function <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a>. This function does not directly handle the new data. It schedules a call to <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>fifo_full_handler()</code></a>. Instead of <a href="sensor.html#void-on_fifo_full-const-ri_gpio_evt_t-evt"><code>on_fifo_full()</code></a> this is called in the main thread of the application. If processing is done inside a function inside an interrupt context this prevents processing of another interrupt. This should be avoided.</p>
<p>Inside <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>fifo_full_handler()</code></a> the FIFO from LIS2DH12 is read (5). The values are store in memory in raw format to be ready to present them to the function <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a> which is important for heartbeat. In parallel the raw values are compacted by removing all unused bits. This is done by the functions <a href="sensor.html#void-pack81012const-uint16_t-sizedata-const-uint8_t-const-data-uint8_t-const-packeddata"><code>pack8/10/12()</code></a>. A timestamp is added to the compacted values. These values are handover to the ringbuffer which writes them to flash (6).</p>
</div>
<div id="using-the-data-by-hearbeat" class="section level2">
<h2><span class="header-section-number">3.3</span> Using the data by hearbeat</h2>
<p>This use case is shown with magenta arrows and numbers inside magenta circles in the figure above.</p>
<p>The heartbeat retrieves the values from all sensors by calling the function <code>app_sensor_get()</code> inside the module <a href="sensor.html#app_sensor.c">app_sensors.c</a>. In the original setup this function calls <a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data"><code>ri_lis2dh12_data_get()</code></a> inside <a href="sensor.html#ruuvi_interface_lis2dh12.c">ruuvi_interface_lis2dh12.c</a>. During initialization this function is replaced by <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
<p><a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a> retrieves the raw acceleration values from memory. Then the values are parsed by calling <a href="sensor.html#rd_status_t-ri_lis2dh12_raw_data_parse-rd_sensor_data_t-const-data-axis3bit16_t-raw_acceleration-uint8_t-raw_temperature"><code>ri_lis2dh12_raw_data_parse()</code></a> and returned to the heartbeat.</p>
</div>
<div id="initialization-during-boot" class="section level2">
<h2><span class="header-section-number">3.4</span> Initialization during boot</h2>
<p>All sensor initialization is done inside <a href="sensor.html#void-setup-void"><code>setup()</code></a> from <a href="sensor.html#main.c">main.c</a>. This function calls <a href="sensor.html#rd_status_t-app_acc_logging_initvoid"><code>app_acc_logging_init()</code></a> inside <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a>. The function checks if the ringbuffer exists. If this is true it activates acceleration logging as described earlier.</p>
</div>
<div id="implementation" class="section level2">
<h2><span class="header-section-number">3.5</span> Implementation</h2>
<div id="app_accelerometer_logging.c" class="section level3">
<h3><span class="header-section-number">3.5.1</span> app_accelerometer_logging.c</h3>
<div id="rd_status_t-app_enable_sensor_loggingvoid" class="section level4">
<h4><span class="header-section-number">3.5.1.1</span> <code>rd_status_t app_enable_sensor_logging(void)</code></h4>
<p>Enables the logging of acceleration data.</p>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is already enabled.</td>
<td></td>
</tr>
<tr class="even">
<td>RD_ERROR_NOT_FOUND</td>
<td>If LIS2DH12 is not available.</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_disable_sensor_loggingvoid" class="section level4">
<h4><span class="header-section-number">3.5.1.2</span> <code>rd_status_t app_disable_sensor_logging(void)</code></h4>
<p>Disables the logging of acceleration data.</p>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is already disabled.</td>
</tr>
<tr class="even">
<td>RD_ERROR_NOT_FOUND</td>
<td>If LIS2DH12 is not available.</td>
</tr>
</tbody>
</table>
</div>
<div id="void-on_fifo_full-const-ri_gpio_evt_t-evt" class="section level4">
<h4><span class="header-section-number">3.5.1.3</span> <code>void on_fifo_full (const ri_gpio_evt_t evt)</code></h4>
<p>Callback function when FIFO full interrupt occurs at LIS2DH12. This functions schedules the execution of <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size"><code>void fifo_full_handler (void * p_event_data, uint16_t event_size)</code></a>. See ruuvi_interface_scheduler.h for parameters used in this function.</p>
</div>
<div id="void-fifo_full_handler-void-p_event_data-uint16_t-event_size" class="section level4">
<h4><span class="header-section-number">3.5.1.4</span> <code>void fifo_full_handler (void * p_event_data, uint16_t event_size)</code></h4>
<p>This function reads the FIFO and stores the data inside the ringbuffer. See ruuvi_interface_scheduler.h for parameters used in this function.</p>
</div>
<div id="void-pack81012const-uint16_t-sizedata-const-uint8_t-const-data-uint8_t-const-packeddata" class="section level4">
<h4><span class="header-section-number">3.5.1.5</span> <code>void pack8/10/12(const uint16_t sizeData, const uint8_t* const data, uint8_t* const packeddata)</code></h4>
<p>These functions remove unused bits from the raw accelerometer values in 8/10/12 bit format and store them in compact form.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sizeData</td>
<td>in</td>
<td>Size of input data.</td>
</tr>
<tr class="even">
<td>data</td>
<td>in</td>
<td>Input data.</td>
</tr>
<tr class="odd">
<td>packeddata</td>
<td>in/out</td>
<td>Memory for storing compacted data.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data" class="section level4">
<h4><span class="header-section-number">3.5.1.6</span> <code>rd_status_t lis2dh12_logged_data_get (rd_sensor_data_t * const data)</code></h4>
<p>This function retrieves raw accelerometer values from memory. The values are parsed and returned inside data. It is called by <code>app_sensor_get()</code> inside <a href="sensor.html#app_sensor.c">app_sensor.c</a> if accelerometer logging is active.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>raw_data</td>
<td>in/out</td>
<td>Memory for storing accelerometer values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_send_last_sampleconst-ri_comm_xfer_fp_t-reply_fp" class="section level4">
<h4><span class="header-section-number">3.5.1.7</span> <code>rd_status_t app_acc_logging_send_last_sample(const ri_comm_xfer_fp_t reply_fp)</code></h4>
<p>This function is called when a request to send the last sample is received by GATT/UART. It retrieves the last sample from memory, does the compacting of the bits by calling <a href="sensor.html#void-pack81012const-uint16_t-sizedata-const-uint8_t-const-data-uint8_t-const-packeddata"><code>pack8/10/12()</code></a> and sends the data to the requester.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>reply_fp</td>
<td>in</td>
<td>Function pointer to reply function.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is not active.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_statevoid" class="section level4">
<h4><span class="header-section-number">3.5.1.8</span> <code>rd_status_t app_acc_logging_state(void)</code></h4>
<p>This function is used to query the state of accelerometer logging. It is called when a control message is received by GATT/UART to return this state to the caller.</p>
<table>
<thead>
<tr class="header">
<th>Special error codes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RD_SUCCESS</td>
<td>If logging is active.</td>
</tr>
<tr class="even">
<td>RD_ERROR_INVALID_STATE</td>
<td>If logging is not active.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_configuration_set-rt_sensor_ctx_t-sensor-rd_sensor_configuration_t-new_config" class="section level4">
<h4><span class="header-section-number">3.5.1.9</span> <code>rd_status_t app_acc_logging_configuration_set (rt_sensor_ctx_t* sensor, rd_sensor_configuration_t* new_config)</code></h4>
<p>This function is called when a request to update the sensor configuration is received by GATT/UART. It checks every configuration parameter if it should be changed. It also checks if the value is different than actual value. If a change is detected it clears the ringbuffer, updates the configuration and stores the configuration in flash.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sensor</td>
<td>in</td>
<td>Sensor context of the sensor which configuration should be changed.</td>
</tr>
<tr class="even">
<td>new_config</td>
<td>in</td>
<td>Structure containing the new configuration values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-app_acc_logging_initvoid" class="section level4">
<h4><span class="header-section-number">3.5.1.10</span> <code>rd_status_t app_acc_logging_init(void)</code></h4>
<p>Initialize acceleration logging during boot. If logging was active before reboot it will be activated. If logging was not active before reboot this function return <code>RD_SUCCESS</code> without activating acceleration logging.</p>
<p>The state if logging was active before reboot is detected by looking for the ringbuffer. If the ringbuffer exists, the logging must be active before reboot.</p>
<p>This function is called from <a href="sensor.html#void-setup-void"><code>setup()</code></a>.</p>
</div>
<div id="rd_status_t-app_acc_logging_uninitvoid" class="section level4">
<h4><span class="header-section-number">3.5.1.11</span> <code>rd_status_t app_acc_logging_uninit(void)</code></h4>
<p>The uninitialization of acceleration logging disables the logging if it is actually active. If logging is not active this function return RD_SUCCESS without doing anything.</p>
</div>
</div>
<div id="app_comms.c" class="section level3">
<h3><span class="header-section-number">3.5.2</span> app_comms.c</h3>
<div id="void-handle_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="section level4">
<h4><span class="header-section-number">3.5.2.1</span> <code>void handle_comms (const ri_comm_xfer_fp_t reply_fp, const uint8_t * const raw_message, size_t data_len)</code></h4>
<p>Added new switch/case which forwards messages regarding configuration and control of acceleration logging to the function <a href="sensor.html#rd_status_t-handle_lis2dh12_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len"><code>handle_lis2dh12_comms()</code></a>.</p>
</div>
<div id="rd_status_t-handle_lis2dh12_comms-const-ri_comm_xfer_fp_t-reply_fp-const-uint8_t-const-raw_message-size_t-data_len" class="section level4">
<h4><span class="header-section-number">3.5.2.2</span> <code>rd_status_t handle_lis2dh12_comms (const ri_comm_xfer_fp_t reply_fp, const uint8_t * const raw_message, size_t data_len)</code></h4>
<p>This function handles the GATT/UART communication needed to control the functionality of acceleration logging.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>reply_fp</td>
<td>in</td>
<td>Function pointer to reply function.</td>
</tr>
<tr class="even">
<td>raw_message</td>
<td>in</td>
<td>Message received.</td>
</tr>
<tr class="odd">
<td>data_len</td>
<td>in</td>
<td>Length of the received message.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="app_config.h" class="section level3">
<h3><span class="header-section-number">3.5.3</span> app_config.h</h3>
<ul>
<li>Added macro APP_SENSOR_LOGGING to control compilation of app_accelerometer_logging.*</li>
<li>If APP_SENSOR_LOGGING is not defined or is defined as 0 the functionality of logging of acceleration data is not available in the application.</li>
</ul>
</div>
<div id="app_heartbeat.c" class="section level3">
<h3><span class="header-section-number">3.5.4</span> app_heartbeat.c</h3>
<div id="void-heartbeat-void-p_event-uint16_t-event_size" class="section level4">
<h4><span class="header-section-number">3.5.4.1</span> <code>void heartbeat (void * p_event, uint16_t event_size)</code></h4>
<p>If acceleration logging is activated, than logging of environmental data is disabled to avoid extreme fragmentation of flash memory.</p>
</div>
</div>
<div id="app_sensor.c" class="section level3">
<h3><span class="header-section-number">3.5.5</span> app_sensor.c</h3>
<div id="rt_sensor_ctx_t-app_sensor_find-const-char-name" class="section level4">
<h4><span class="header-section-number">3.5.5.1</span> <code>rt_sensor_ctx_t* app_sensor_find (const char *name)</code></h4>
<p>Find sensor by its name. Works only with initialized sensors, will not return a sensor which is supported in firmware but not initialized.</p>
<p>This function is called by <a href="sensor.html#rd_status_t-app_enable_sensor_loggingvoid"><code>app_enable_sensor_logging()</code></a> and <a href="sensor.html#rd_status_t-app_disable_sensor_loggingvoid"><code>app_disable_sensor_logging()</code></a> to retrieve the sensor context.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>in</td>
<td>Name of the sensor.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="main.c" class="section level3">
<h3><span class="header-section-number">3.5.6</span> main.c</h3>
<div id="void-setup-void" class="section level4">
<h4><span class="header-section-number">3.5.6.1</span> <code>void setup (void)</code></h4>
<p>Added call to <a href="sensor.html#rd_status_t-app_acc_logging_initvoid"><code>app_acc_logging_init()</code></a> to initialize acceleration logging.</p>
</div>
</div>
<div id="ruuvi_interface_lis2dh12.c" class="section level3">
<h3><span class="header-section-number">3.5.7</span> ruuvi_interface_lis2dh12.c</h3>
<div id="rd_status_t-ri_lis2dh12_acceleration_raw_get-uint8_t-const-raw_data" class="section level4">
<h4><span class="header-section-number">3.5.7.1</span> <code>rd_status_t ri_lis2dh12_acceleration_raw_get (uint8_t * const raw_data)</code></h4>
<p>This function reads raw acceleration values from the registers of LIS2DH12. It is called from the <a href="sensor.html#void-fifo_full_handler-void-p_event_data-uint16_t-event_size">interrupt handler</a> inside <a href="sensor.html#app_accelerometer_logging.c">app_accelerometer_logging.c</a> and from <a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data"><code>ri_lis2dh12_data_get()</code></a>.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>raw_data</td>
<td>in/out</td>
<td>Memory for storing raw accelerometer values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data" class="section level4">
<h4><span class="header-section-number">3.5.7.2</span> <code>rd_status_t ri_lis2dh12_data_get (rd_sensor_data_t * const data)</code></h4>
<p>The original function <code>ri_lis2dh12_data_get()</code> is split into retrieving raw values from the sensor and parsing these data. Parsing is done by <a href="sensor.html#rd_status_t-ri_lis2dh12_raw_data_parse-rd_sensor_data_t-const-data-axis3bit16_t-raw_acceleration-uint8_t-raw_temperature"><code>ri_lis2dh12_raw_data_parse()</code></a>.</p>
<p>This function is used if the acceleration logging is not active. If acceleration logging is active this function is replaced by <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>data</td>
<td>in/out</td>
<td>Structure for storing parsed accelerometer values.</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-ri_lis2dh12_raw_data_parse-rd_sensor_data_t-const-data-axis3bit16_t-raw_acceleration-uint8_t-raw_temperature" class="section level4">
<h4><span class="header-section-number">3.5.7.3</span> <code>rd_status_t ri_lis2dh12_raw_data_parse (rd_sensor_data_t * const data, axis3bit16_t *raw_acceleration, uint8_t *raw_temperature)</code></h4>
<p>This function parses raw values from the sensor and stores the values inside data. It is called from <a href="sensor.html#rd_status_t-ri_lis2dh12_data_get-rd_sensor_data_t-const-data"><code>ri_lis2dh12_data_get()</code></a> and from <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a>.</p>
<table>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>data</td>
<td>in/out</td>
<td>Structure for storing parsed accelerometer values.</td>
</tr>
<tr class="even">
<td>raw_acceleration</td>
<td>in</td>
<td>Raw acceleration values.</td>
</tr>
<tr class="odd">
<td>raw_temperature</td>
<td>in</td>
<td>Raw temperature value. If used from <a href="sensor.html#rd_status_t-lis2dh12_logged_data_get-rd_sensor_data_t-const-data"><code>lis2dh12_logged_data_get()</code></a> this parameter is NULL.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ruuvi_nrf5_sdk_rtc_mcu.c" class="section level3">
<h3><span class="header-section-number">3.5.8</span> ruuvi_nrf5_sdk_rtc_mcu.c</h3>
<div id="rd_status_t-ri_set_rtc_millisuint64_t-millis" class="section level4">
<h4><span class="header-section-number">3.5.8.1</span> <code>rd_status_t ri_set_rtc_millis(uint64_t millis)</code></h4>
<p>Set system time by external source. Set RTC to zero.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>millis</td>
<td>in</td>
<td>External time.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="ringbuffer-module" class="section level2">
<h2><span class="header-section-number">3.6</span> Ringbuffer module</h2>
<hr />
<p><code>ruuvi.firmware.c\src\ruuvi.drivers.c\src\tasks\ruuvi_task_flash_ringbuffer.h</code>
<code>ruuvi.firmware.c\src\ruuvi.drivers.c\src\tasks\ruuvi_task_flash_ringbuffer.c</code></p>
<hr />
<div id="general-functionality" class="section level3">
<h3><span class="header-section-number">3.6.1</span> General functionality</h3>
<p>A ringbuffer is a data structure that represents a fixed-sized queue. As the following figure shows, the current read or write position is indicated by the two attributes start and end. After every read or write, the corresponding value points to the next area.</p>
<center>
<img src="gfx/org/ringbuffer.png" />
</center>
</div>
<div id="project-related-use-case" class="section level3">
<h3><span class="header-section-number">3.6.2</span> Project-related use case</h3>
<p>In the use case of the Ruuvi Tag the data of the ringbuffer should be stored in the flash memory of the sensor. This flash memory is structured in flashpages, each consisting of several records.</p>
<p>The implemented ringbuffer reserves a selected number of flashpages and stores its current state (size, start and end attribute, reserved pages) in the following struct at a previously defined memory address. The maximum size of the ringbuffer is defined by the property <code>RT_FLASH_RINGBUFFER_MAXSIZE</code>. For the memory access the FDS library is used.</p>
<table>
<thead>
<tr class="header">
<th>rt_flash_ringbuffer_state_t</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>size</td>
<td>uint8_t</td>
<td>Number of pages</td>
</tr>
<tr class="even">
<td>start</td>
<td>uint8_t</td>
<td>Start position</td>
</tr>
<tr class="odd">
<td>end</td>
<td>uint8_t</td>
<td>End position</td>
</tr>
<tr class="even">
<td>reserved_pages[]</td>
<td>fds_reserve_token_t</td>
<td>Array of fds_reserve_token</td>
</tr>
</tbody>
</table>
<p>The following struct makes it possible to buffer the accumulating accelerometer data until the amount of data for an entire flashpage is reached.</p>
<table>
<thead>
<tr class="header">
<th>rt_flash_ringbuffer_flashpage_t</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>max_size</td>
<td>uint16_t</td>
<td>Maximum size of the flashpage</td>
</tr>
<tr class="even">
<td>actual_size</td>
<td>uint16_t</td>
<td>Actual size of the flashpage</td>
</tr>
<tr class="odd">
<td>packeddata[4073]</td>
<td>uint8_t</td>
<td>Actual picked data</td>
</tr>
</tbody>
</table>
</div>
<div id="implemented-functions" class="section level3">
<h3><span class="header-section-number">3.6.3</span> Implemented functions</h3>
<div id="rd_status_t-rt_flash_ringbuffer_createconst-uint32_t-page_id-const-uint32_t-record_id-const-uint8_t-number_of_pages-const-uint16_t-page_size" class="section level4">
<h4><span class="header-section-number">3.6.3.1</span> <code>rd_status_t rt_flash_ringbuffer_create(const uint32_t page_id, const uint32_t record_id, const uint8_t number_of_pages, const uint16_t page_size)</code></h4>
<p>This function creates a new ringbuffer, reserves the pages in flash and initializes the ringbuffer state.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>page_id</td>
<td>in</td>
<td>PageID of the ringbuffer state</td>
</tr>
<tr class="even">
<td>record_id</td>
<td>in</td>
<td>RecordID of the ringbuffer state</td>
</tr>
<tr class="odd">
<td>number_of_pages</td>
<td>in</td>
<td>Number of pages in the ringbuffer</td>
</tr>
<tr class="even">
<td>page_size</td>
<td>in</td>
<td>Size of each page in the ringbuffer</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_createconst-uint32_t-page_id-const-uint32_t-record_id-const-uint16_t-size-const-uint8_t-packeddata-rt_flash_ringbuffer_flashpage_t-flashpage" class="section level4">
<h4><span class="header-section-number">3.6.3.2</span> <code>rd_status_t rt_flash_ringbuffer_create(const uint32_t page_id, const uint32_t record_id, const uint16_t size, const uint8_t* packeddata, rt_flash_ringbuffer_flashpage_t* flashpage)</code></h4>
<p>This function collects data to store in ringbuffer. After the amount of data of an entire flashpage is reached, the write operation is called.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>page_id</td>
<td>in</td>
<td>PageID of the ringbuffer state</td>
</tr>
<tr class="even">
<td>record_id</td>
<td>in</td>
<td>RecordID of the ringbuffer state</td>
</tr>
<tr class="odd">
<td>size</td>
<td>in</td>
<td>Size of packeddata</td>
</tr>
<tr class="even">
<td>packeddata</td>
<td>in</td>
<td>Data to collect for flashpage</td>
</tr>
<tr class="odd">
<td>flashpage</td>
<td>in/out</td>
<td>Flashpage struct</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_writeconst-uint32_t-page_id-const-uint32_t-record_id-const-uint16_t-size-const-void-data" class="section level4">
<h4><span class="header-section-number">3.6.3.3</span> <code>rd_status_t rt_flash_ringbuffer_write(const uint32_t page_id, const uint32_t record_id, const uint16_t size, const void* data)</code></h4>
<p>This function writes data to the ringbuffer.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>page_id</td>
<td>in</td>
<td>PageID of the ringbuffer state</td>
</tr>
<tr class="even">
<td>record_id</td>
<td>in</td>
<td>RecordID of the ringbuffer state</td>
</tr>
<tr class="odd">
<td>size</td>
<td>in</td>
<td>Size of data</td>
</tr>
<tr class="even">
<td>data</td>
<td>in</td>
<td>Data to be written</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_readconst-uint32_t-page_id-const-uint32_t-record_id-const-uint16_t-size-void-data" class="section level4">
<h4><span class="header-section-number">3.6.3.4</span> <code>rd_status_t rt_flash_ringbuffer_read(const uint32_t page_id, const uint32_t record_id, const uint16_t size, void* data)</code></h4>
<p>This functiion reads data from the ringbuffer.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>page_id</td>
<td>in</td>
<td>PageID of the ringbuffer state</td>
</tr>
<tr class="even">
<td>record_id</td>
<td>in</td>
<td>RecordID of the ringbuffer state</td>
</tr>
<tr class="odd">
<td>size</td>
<td>in</td>
<td>Size of data</td>
</tr>
<tr class="even">
<td>data</td>
<td>in/out</td>
<td>Data to be read</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_clearconst-uint32_t-page_id-const-uint32_t-record_id" class="section level4">
<h4><span class="header-section-number">3.6.3.5</span> <code>rd_status_t rt_flash_ringbuffer_clear(const uint32_t page_id, const uint32_t record_id)</code></h4>
<p>This function clears the contents of the ringbuffer (start/end attribute of the ringbuffer state are set to 0).</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>page_id</td>
<td>in</td>
<td>PageID of the ringbuffer state</td>
</tr>
<tr class="even">
<td>record_id</td>
<td>in</td>
<td>RecordID of the ringbuffer state</td>
</tr>
</tbody>
</table>
</div>
<div id="rd_status_t-rt_flash_ringbuffer_deleteconst-uint32_t-page_id-const-uint32_t-record_id" class="section level4">
<h4><span class="header-section-number">3.6.3.6</span> <code>rd_status_t rt_flash_ringbuffer_delete(const uint32_t page_id, const uint32_t record_id)</code></h4>
<p>This function deletes the entire ringbuffer.</p>
<table>
<thead>
<tr class="header">
<th>Parameters</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>page_id</td>
<td>in</td>
<td>PageID of the ringbuffer state</td>
</tr>
<tr class="even">
<td>record_id</td>
<td>in</td>
<td>RecordID of the ringbuffer state</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="exemplary-use" class="section level3">
<h3><span class="header-section-number">3.6.4</span> Exemplary use</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="sensor.html#cb6-1"></a><span class="pp">#include </span><span class="im">&quot;ruuvi_task_flash_ringbuffer.h&quot;</span></span>
<span id="cb6-2"><a href="sensor.html#cb6-2"></a></span>
<span id="cb6-3"><a href="sensor.html#cb6-3"></a><span class="co">// create ringbuffer</span></span>
<span id="cb6-4"><a href="sensor.html#cb6-4"></a>rd_status_t error = rt_flash_ringbuffer_create(FILE_ID, RECORD_KEY, RT_FLASH_RINGBUFFER_MAXSIZE, <span class="dv">4073</span>);</span>
<span id="cb6-5"><a href="sensor.html#cb6-5"></a></span>
<span id="cb6-6"><a href="sensor.html#cb6-6"></a><span class="co">// create flashpage struct</span></span>
<span id="cb6-7"><a href="sensor.html#cb6-7"></a>rt_flash_ringbuffer_flashpage_t flashpage;</span>
<span id="cb6-8"><a href="sensor.html#cb6-8"></a>flashpage.actual_size = <span class="dv">0</span>;</span>
<span id="cb6-9"><a href="sensor.html#cb6-9"></a>flashpage.max_size = <span class="dv">4073</span>;</span>
<span id="cb6-10"><a href="sensor.html#cb6-10"></a></span>
<span id="cb6-11"><a href="sensor.html#cb6-11"></a><span class="co">// write data </span></span>
<span id="cb6-12"><a href="sensor.html#cb6-12"></a><span class="dt">int</span> i=<span class="dv">1</span>;</span>
<span id="cb6-13"><a href="sensor.html#cb6-13"></a><span class="cf">while</span>(i &lt;= <span class="dv">1500</span>) {</span>
<span id="cb6-14"><a href="sensor.html#cb6-14"></a>    rt_flash_ringbuffer_collect_flashpage(FILE_ID, RECORD_KEY, <span class="kw">sizeof</span>(i),  &amp;i, &amp;flashpage); </span>
<span id="cb6-15"><a href="sensor.html#cb6-15"></a>    <span class="co">// the collect operation calls the write operation when the data size for a flashpage is reached</span></span>
<span id="cb6-16"><a href="sensor.html#cb6-16"></a>    i++;</span>
<span id="cb6-17"><a href="sensor.html#cb6-17"></a>}</span>
<span id="cb6-18"><a href="sensor.html#cb6-18"></a></span>
<span id="cb6-19"><a href="sensor.html#cb6-19"></a><span class="co">// read data from flash</span></span>
<span id="cb6-20"><a href="sensor.html#cb6-20"></a>rt_flash_ringbuffer_flashpage_t flashpage_read;</span>
<span id="cb6-21"><a href="sensor.html#cb6-21"></a>error = rt_flash_ringbuffer_read(FILE_ID, RECORD_KEY, <span class="kw">sizeof</span>(flashpage_read), &amp;flashpage_read);</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="getting-started.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="gateway.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/11-docs-sensor.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bchwtz-bdcs.pdf", "bchwtz-bdcs.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
